<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DartStream Score Bug</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            background: transparent;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            color: white;
            margin: 0;
            position: relative;
        }

        /* Chroma key container - green screen background */
        .chroma-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #00ff00; /* Pure green for chroma key */
            z-index: 1;
        }

        /* Content wrapper - holds score bug and ad */
        .content-wrapper {
            position: relative;
            width: 100vw;
            height: 100vh;
            z-index: 2;
        }

        /* PDC-Style Overlay at Top */
        .score-bug-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 55vw;
            height: auto;
            min-width: 500px;
            min-height: 200px;
            background: linear-gradient(to bottom, rgba(0,0,0,1), rgba(15,15,15,1));
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.8);
            overflow: visible;
            resize: both;
            border: 2px solid rgba(250, 204, 21, 0.3);
            z-index: 999;
            aspect-ratio: 16 / 9;
        }

        .score-bug-overlay.resize-mode {
            border-color: rgba(250, 204, 21, 0.5);
        }

        .score-bug-overlay.resize-mode:hover {
            border-color: rgba(250, 204, 21, 0.8);
        }

        /* Resize handles */
        .resize-handle {
            position: absolute;
            background: #facc15;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
            pointer-events: none;
        }

        .score-bug-overlay.resize-mode .resize-handle,
        .ad-bar.resize-mode .resize-handle {
            pointer-events: auto;
        }

        .score-bug-overlay.resize-mode:hover .resize-handle,
        .ad-bar.resize-mode:hover .resize-handle {
            opacity: 0.7;
        }

        .resize-handle:hover {
            opacity: 1 !important;
        }

        .resize-handle.corner {
            width: 20px;
            height: 20px;
            border-radius: 50%;
        }

        .resize-handle.edge {
            background: rgba(250, 204, 21, 0.5);
        }

        .resize-nw {
            top: -10px;
            left: -10px;
            cursor: nw-resize;
        }

        .resize-ne {
            top: -10px;
            right: -10px;
            cursor: ne-resize;
        }

        .resize-sw {
            bottom: -10px;
            left: -10px;
            cursor: sw-resize;
        }

        .resize-se {
            bottom: -10px;
            right: -10px;
            cursor: se-resize;
        }

        .resize-n {
            top: -5px;
            left: 20px;
            right: 20px;
            height: 10px;
            cursor: n-resize;
        }

        .resize-s {
            bottom: -5px;
            left: 20px;
            right: 20px;
            height: 10px;
            cursor: s-resize;
        }

        .resize-e {
            right: -5px;
            top: 20px;
            bottom: 20px;
            width: 10px;
            cursor: e-resize;
        }

        .resize-w {
            left: -5px;
            top: 20px;
            bottom: 20px;
            width: 10px;
            cursor: w-resize;
        }

        .score-bug-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .match-header {
            background: #1a1a2e;
            padding: 0.4vw 1.2vw;
            text-align: center;
            border-bottom: 0.15vw solid #facc15;
            cursor: grab;
            -webkit-user-select: none;
            user-select: none;
        }
        
        .match-header:active {
            cursor: grabbing;
        }

        .match-title {
            font-size: 1.2vw;
            color: #94a3b8;
            margin-bottom: 0.1vw;
        }

        .match-score {
            font-size: 1.8vw;
            font-weight: 900;
            color: white;
        }

        .players-container {
            position: relative;
            width: 100%;
            max-width: 1920px;
            margin: 0 auto;
        }

        .column-headers {
            display: grid;
            grid-template-columns: 3vw 1fr 1.5vw 4vw 4vw 5vw 4.5vw 7vw 2vw;
            align-items: center;
            padding: 0.5vw 1vw;
            gap: 0.8vw;
            background: rgba(0,0,0,0.3);
            border-bottom: 2px solid #facc15;
            position: relative;
        }

        .column-header {
            text-align: center;
            font-size: 0.9vw;
            font-weight: bold;
            color: #facc15;
            text-transform: uppercase;
            position: relative;
        }

        .column-header.empty {
            visibility: hidden;
        }

        .player-row {
            display: grid;
            grid-template-columns: 3vw 1fr 1.5vw 4vw 4vw 5vw 4.5vw 7vw 2vw;
            align-items: center;
            padding: 0.5vw 1vw;
            gap: 0.8vw;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative;
            transition: background 0.3s ease;
        }
        .player-row > * {
            text-align: center;
        }

        .player-row:last-child {
            border-bottom: none;
        }

        .turn-indicator {
            width: 1.3vw;
            height: 1.3vw;
            border-radius: 50%;
            margin: 0 auto;
        }

        .turn-indicator.start {
            background: #10b981;
            border: 0.15vw solid #059669;
        }

        .turn-indicator.inactive {
            background: transparent;
            border: 0.15vw solid #334155;
        }

        .player-name {
            font-size: 1.4vw;
            font-weight: bold;
            color: white;
            text-align: left;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .flag-icon {
            height: 1.8vw;
            width: auto;
            border-radius: 0.15vw;
            display: block;
            margin: 0 auto;
        }

        .stat-group {
            text-align: center;
        }

        .stat-value {
            font-size: 1.2vw;
            font-weight: bold;
            color: white;
        }

        .legs-value {
            font-size: 1.5vw;
            font-weight: 900;
            color: #facc15;
        }

        .score-box {
            background: #000;
            padding: 0.4vw 0.8vw;
            border-radius: 0.3vw;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .score-value {
            font-size: 1.6vw;
            font-weight: 900;
            color: white;
            transition: opacity 0.3s ease;
        }

        .shot-display {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8vw;
            font-weight: 900;
            color: #facc15;
            background: rgba(0,0,0,0.95);
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .shot-display.show {
            animation: shotFade 2s ease-out forwards;
        }

        @keyframes shotFade {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }
            10% {
                opacity: 1;
                transform: scale(1.15);
            }
            20% {
                opacity: 1;
                transform: scale(1);
            }
            80% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0.9);
            }
        }

        .active-arrow {
            width: 0;
            height: 0;
            border-top: 0.8vw solid transparent;
            border-bottom: 0.8vw solid transparent;
            border-right: 1vw solid #ef4444;
            opacity: 0;
            transition: all 0.4s ease;
            position: absolute;
            right: 0.3vw;
        }

        .player-row.active .active-arrow {
            opacity: 1;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 1.5vw;
            right: 1.5vw;
            padding: 0.7vw 1.3vw;
            border-radius: 0.5vw;
            font-size: 1vw;
            font-weight: bold;
            background: rgba(0,0,0,0.8);
            border: 0.15vw solid #334155;
            z-index: 2000;
        }

        .connection-status.connected {
            border-color: #10b981;
            color: #10b981;
        }

        .connection-status.disconnected {
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 2s infinite;
        }

        .connection-status.setup {
            border-color: #3b82f6;
            color: #3b82f6;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Code Entry Bar */
        .code-entry-bar {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a2e;
            padding: 12px 20px;
            border-radius: 8px;
            border: 2px solid #facc15;
            z-index: 3000;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .code-entry-bar label {
            color: #facc15;
            font-size: 14px;
            font-weight: bold;
        }

        .code-entry-bar input {
            width: 80px;
            padding: 8px;
            font-size: 18px;
            text-align: center;
            letter-spacing: 5px;
            font-weight: bold;
            border: 2px solid #facc15;
            background: #2a2a3e;
            color: #facc15;
            border-radius: 5px;
        }

        .code-entry-bar button {
            background: #facc15;
            color: #1a1a2e;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .code-entry-bar .divider {
            width: 2px;
            height: 30px;
            background: rgba(250, 204, 21, 0.3);
        }
        
        .controller-status {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border: 1px solid rgba(250, 204, 21, 0.3);
        }
        
        .controller-status label {
            font-size: 12px;
            color: #94a3b8;
        }
        
        .controller-code-display {
            font-size: 16px;
            font-weight: bold;
            letter-spacing: 3px;
            color: #facc15;
            background: #2a2a3e;
            padding: 4px 10px;
            border-radius: 4px;
            border: 1px solid #facc15;
        }
        
        .connection-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ef4444;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }
        
        .connection-indicator.connected {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            animation: pulse-green 2s infinite;
        }
        
        @keyframes pulse-green {
            0%, 100% { 
                box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            }
            50% { 
                box-shadow: 0 0 20px rgba(16, 185, 129, 0.8);
            }
        }

        .code-entry-bar button:hover {
            background: #fcd34d;
        }

        .hidden {
            display: none;
        }

        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(26, 26, 46, 0.98);
            padding: 2vw;
            border-radius: 0.8vw;
            border: 0.2vw solid #facc15;
            z-index: 3000;
            width: 50vw;
            max-width: 800px;
            min-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.8);
        }

        .settings-panel h3 {
            color: #facc15;
            font-size: 1.2vw;
            margin-bottom: 1vw;
        }

        .settings-input, .settings-select {
            width: 100%;
            padding: 0.5vw;
            margin-bottom: 0.8vw;
            font-size: 0.9vw;
            background: #2a2a3e;
            color: white;
            border: 0.1vw solid #334155;
            border-radius: 0.3vw;
        }

        .settings-select {
            cursor: pointer;
        }

        .settings-label {
            display: block;
            color: #94a3b8;
            font-size: 0.75vw;
            margin-bottom: 0.3vw;
            text-transform: uppercase;
            font-weight: bold;
        }

        .settings-toggle {
            background: #facc15;
            color: #1a1a2e;
            padding: 0.6vw 1.2vw;
            border: none;
            border-radius: 0.3vw;
            font-size: 0.9vw;
            font-weight: bold;
            cursor: pointer;
            margin-top: 0.5vw;
        }

        .settings-toggle:hover {
            background: #fcd34d;
        }

        .settings-buttons {
            display: flex;
            gap: 0.5vw;
            margin-top: 0.5vw;
        }

        .settings-buttons button {
            flex: 1;
        }

        .resize-mode-indicator {
            position: fixed;
            top: 70px;
            right: 10px;
            background: rgba(250, 204, 21, 0.9);
            color: #1a1a2e;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
            z-index: 2999;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .settings-toggle.close {
            background: #64748b;
        }

        .settings-toggle.close:hover {
            background: #94a3b8;
        }

        /* Footer */
        .score-bug-footer {
            background: #1a1a2e;
            padding: 0.4vw 1.2vw;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 0.15vw solid #facc15;
        }

        .footer-section {
            font-size: 1.2vw;
            color: #94a3b8;
            flex: 1;
        }

        .footer-section:first-child {
            text-align: left;
        }

        .footer-section:nth-child(2) {
            text-align: center;
        }

        .footer-section:last-child {
            text-align: right;
        }

        /* Column Visibility Controls */
        .hide-flags .flag-container,
        .hide-flags .column-headers > div:nth-child(1) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-indicator .turn-indicator,
        .hide-indicator .column-headers > div:nth-child(3) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-sets .column-headers > div:nth-child(4),
        .hide-sets .player-row > div:nth-child(4) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-legs .column-headers > div:nth-child(5),
        .hide-legs .player-row > div:nth-child(5) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-avg .column-headers > div:nth-child(6),
        .hide-avg .player-row > div:nth-child(6) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-darts .column-headers > div:nth-child(7),
        .hide-darts .player-row > div:nth-child(7) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .hide-score .column-headers > div:nth-child(8),
        .hide-score .player-row > div:nth-child(8) {
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* Settings Section Styles */
        .settings-section-divider {
            margin-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.2);
            padding-top: 15px;
        }

        .settings-checkbox {
            margin-right: 8px;
        }

        .ad-image-hidden {
            display: none;
        }

        /* Advertisement Bar - TV Bug Style */
        .ad-bar {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 150px;
            min-width: 150px;
            min-height: 100px;
            background: linear-gradient(135deg, rgba(0,0,0,0.95), rgba(20,20,40,0.92));
            border-radius: 15px;
            border: 3px solid #facc15;
            box-shadow: -4px 0 20px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 998;
            overflow: visible;
            resize: both;
            transition: all 1s ease-in-out;
        }

        .ad-bar.resize-mode {
            border-color: rgba(250, 204, 21, 0.8);
        }

        /* Ad transition directions */
        body.ad-hidden .ad-bar.slide-left {
            margin-left: -600px;
        }

        body.ad-hidden .ad-bar.slide-right {
            margin-right: -600px;
        }

        body.ad-hidden .ad-bar.slide-up {
            margin-top: -400px;
        }

        body.ad-hidden .ad-bar.slide-down {
            margin-bottom: -400px;
        }

        body.ad-hidden .ad-bar.fade {
            opacity: 0;
        }

        /* Show ad - reset margins */
        body.ad-visible .ad-bar {
            margin-left: 0;
            margin-right: 0;
            margin-top: 0;
            margin-bottom: 0;
            opacity: 1;
        }

        .ad-content {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .ad-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: block;
        }

        .ad-placeholder {
            font-size: 16px;
            color: #facc15;
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }

        .ad-placeholder.ad-image-hidden {
            display: none;
        }

        /* Ad Control Buttons */
        .ad-controls {
            position: fixed;
            top: 20px;
            left: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
            flex-direction: row;
        }

        .ad-controls.enabled {
            display: flex;
        }

        .ad-toggle-btn,
        .ad-lock-btn {
            background: linear-gradient(135deg, #facc15 0%, #f59e0b 100%);
            color: #1a1a2e;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(250, 204, 21, 0.3);
            transition: all 0.3s ease;
        }

        .ad-toggle-btn:hover,
        .ad-lock-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(250, 204, 21, 0.5);
        }

        .ad-toggle-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .ad-lock-btn {
            background: linear-gradient(135deg, #64748b 0%, #475569 100%);
            box-shadow: 0 4px 15px rgba(100, 116, 139, 0.3);
        }

        .ad-lock-btn.locked {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        /* Ad Upload Section in Settings */
        .ad-upload-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #334155;
        }

        .file-input-wrapper {
            position: relative;
            margin-top: 0.5rem;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background: #334155;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .file-input-label:hover {
            background: #475569;
        }

        .file-input {
            display: none;
        }

        .ad-preview {
            margin-top: 1rem;
            max-width: 100%;
            max-height: 150px;
            border: 2px solid #334155;
            border-radius: 5px;
            display: none;
        }

        .ad-preview.visible {
            display: block;
        }

        /* OBS Setup Modal */
        .obs-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .obs-modal.visible {
            display: flex;
        }

        .obs-modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 3px solid #facc15;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.8);
        }

        .obs-modal-content h2 {
            color: #facc15;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .obs-modal-content h3 {
            color: #facc15;
            margin-top: 20px;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .obs-modal-content ol {
            margin-left: 20px;
            line-height: 1.8;
        }

        .obs-modal-content li {
            margin-bottom: 10px;
        }

        .obs-modal-content code {
            background: rgba(0, 0, 0, 0.5);
            padding: 2px 6px;
            border-radius: 3px;
            color: #10b981;
            font-family: monospace;
        }

        .obs-close-btn {
            display: block;
            margin: 20px auto 0;
            padding: 10px 30px;
            background: #facc15;
            color: #1a1a2e;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .obs-close-btn:hover {
            background: #fbbf24;
            transform: scale(1.05);
        }

        .obs-info-button {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            margin-left: 10px;
        }

        .obs-info-button:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }
    </style>
</head>
<body class="ad-hidden">
    <!-- Chroma Key Background -->
    <div class="chroma-container"></div>
    
    <!-- Content Wrapper -->
    <div class="content-wrapper">
    
    <!-- Top Control Bar -->
    <div style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 3000; display: flex; gap: 15px; align-items: center; background: rgba(26, 26, 46, 0.95); padding: 12px 20px; border-radius: 8px; border: 2px solid #facc15; box-shadow: 0 4px 10px rgba(0,0,0,0.5);">
        <!-- Connection Code Entry -->
        <div style="display: flex; gap: 8px; align-items: center;">
            <label style="color: #facc15; font-size: 14px; font-weight: bold;">Code:</label>
            <input type="text" id="pairingCode" placeholder="0000" maxlength="4" onkeypress="if(event.key === 'Enter') connectWithCode()" style="width: 80px; padding: 6px; font-size: 16px; text-align: center; letter-spacing: 3px; font-weight: bold; border: 2px solid #facc15; background: #2a2a3e; color: #facc15; border-radius: 5px;">
            <button id="connectBtn" onclick="connectWithCode()" style="background: #facc15; color: #1a1a2e; padding: 6px 12px; font-size: 14px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer;">Connect</button>
        </div>
        
        <!-- Connection Status -->
        <div id="connectionStatus" style="color: #ff6b6b; font-size: 14px; font-weight: bold; padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 5px;">
            ?? Not connected
        </div>
        
        <!-- Divider -->
        <div class="divider"></div>
        
        <!-- Controller Connection Info -->
        <div class="controller-status">
            <label>Controller:</label>
            <div class="controller-code-display" id="topConnectionCodeDisplay">----</div>
            <div class="connection-indicator" id="controllerIndicator"></div>
        </div>
        
        <!-- Divider -->
        <div class="divider"></div>
        
        <!-- Settings Button -->
        <button onclick="toggleSettings()" style="background: #8b5cf6; color: white; padding: 6px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px;">?? Score Bug</button>
        
        <!-- Ad Toggle Button -->
        <button onclick="toggleAd()" style="background: #10b981; color: white; padding: 6px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px;">?? Toggle Ad</button>
        
        <!-- Ad Settings Button -->
        <button onclick="toggleAdSettings()" style="background: #6366f1; color: white; padding: 6px 16px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 14px;">?? Ad Settings</button>
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel hidden" id="settingsPanel">
        <h3>Score Bug Settings</h3>
        <label class="settings-label">Event Title (Header)</label>
        <input type="text" class="settings-input" id="headerText" placeholder="Men's Round Robin Board 11" value="">
        
        <label class="settings-label">Footer - Group</label>
        <input type="text" class="settings-input" id="footerGroupInput" placeholder="Group A" value="">
        
        <label class="settings-label">Footer - Event Name</label>
        <input type="text" class="settings-input" id="footerEventInput" placeholder="Premier League Darts" value="">
        
        <label class="settings-label">Footer - Match Format</label>
        <input type="text" class="settings-input" id="footerFormatInput" placeholder="Best of 5 Legs" value="">
        
        <label class="settings-label">Home Player Flag</label>
        <select class="settings-select" id="homeFlag">
            <option value="">No Flag</option>
            <option value="canada.png">Canada</option>
            <option value="united-states-of-america.png">USA</option>
            <option value="england.png">England</option>
            <option value="united-kingdom.png">Wales</option>
            <option value="united-kingdom.png">Scotland</option>
            <option value="philippines.png">Philippines</option>
        </select>
        
        <label class="settings-label">Away Player Flag</label>
        <select class="settings-select" id="awayFlag">
            <option value="">No Flag</option>
            <option value="canada.png">Canada</option>
            <option value="united-states-of-america.png">USA</option>
            <option value="england.png">England</option>
            <option value="united-kingdom.png">Wales</option>
            <option value="united-kingdom.png">Scotland</option>
            <option value="philippines.png">Philippines</option>
        </select>
        
        <!-- Resize Mode Section -->
        <label class="settings-label settings-section-divider">Resize Settings</label>
        
        <label class="settings-label">
            <input type="checkbox" id="keepResizeMode" class="settings-checkbox">
            Keep Resize Mode Active (allows resizing without opening settings)
        </label>
        
        <!-- Column Visibility Section -->
        <label class="settings-label settings-section-divider">Column Visibility</label>
        
        <label class="settings-label">
            <input type="checkbox" id="showFlags" checked class="settings-checkbox">
            Show Flags
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showIndicator" checked class="settings-checkbox">
            Show Throw Indicator
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showSets" checked class="settings-checkbox">
            Show Sets
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showLegs" checked class="settings-checkbox">
            Show Legs
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showAvg" checked class="settings-checkbox">
            Show Average
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showDarts" checked class="settings-checkbox">
            Show Darts
        </label>
        
        <label class="settings-label">
            <input type="checkbox" id="showScore" checked class="settings-checkbox">
            Show Score
        </label>
        
        <div class="settings-buttons">
            <button class="settings-toggle" onclick="saveSettings()">?? Save</button>
            <button class="settings-toggle obs-info-button" onclick="showOBSSetup()">?? OBS Setup</button>
            <button class="settings-toggle close" onclick="toggleSettings()">Close</button>
        </div>
    </div>

    <!-- Ad Settings Panel -->
    <div class="settings-panel hidden" id="adSettingsPanel">
        <h3>Advertisement Settings</h3>
        
        <div style="background: rgba(250, 204, 21, 0.1); border: 2px solid #facc15; border-radius: 8px; padding: 15px; margin-bottom: 15px;">
            <label class="settings-label" style="margin-bottom: 5px;">Controller Connection Code</label>
            <div style="background: #1a1a2e; border: 2px solid #facc15; border-radius: 6px; padding: 12px; text-align: center;">
                <div style="font-size: 28px; font-weight: bold; letter-spacing: 6px; color: #facc15;" id="connectionCodeDisplay">----</div>
            </div>
            <div style="font-size: 12px; color: #94a3b8; margin-top: 8px; text-align: center;">
                Enter this code in your OBS Controller to connect
            </div>
        </div>
        
        <div class="file-input-wrapper">
            <label class="file-input-label" for="adImageUpload">
                Upload Ad Image (PNG/JPG)
            </label>
            <input type="file" id="adImageUpload" class="file-input" accept="image/png,image/jpeg,image/jpg" onchange="loadAdImage(event)">
        </div>
        
        <img id="adPreview" class="ad-preview" alt="Ad Preview">
        
        <label class="settings-label">
            <input type="checkbox" id="adEnableTransitions" class="settings-checkbox">
            Enable Slide Transitions
        </label>
        
        <label class="settings-label">Transition Type</label>
        <select class="settings-select" id="adTransitionType">
            <option value="slide-left">Slide Left</option>
            <option value="slide-right">Slide Right</option>
            <option value="slide-up">Slide Up</option>
            <option value="slide-down">Slide Down</option>
            <option value="fade">Fade In/Out</option>
        </select>
        
        <label class="settings-label">Transition Duration (seconds)</label>
        <input type="number" class="settings-input" id="adTransitionDuration" value="1" min="0.1" max="5" step="0.1">
        
        <label class="settings-label">
            <input type="checkbox" id="adResizeMode" class="settings-checkbox">
            Enable Resize/Move Mode for Ad
        </label>
        
        <div class="settings-buttons">
            <button class="settings-toggle" onclick="saveAdSettingsPanel()">?? Save</button>
            <button class="settings-toggle close" onclick="toggleAdSettings()">Close</button>
        </div>
    </div>

    <!-- OBS Setup Instructions Modal -->
    <div class="obs-modal" id="obsModal">
        <div class="obs-modal-content">
            <h2>?? OBS Studio Setup Instructions</h2>
            
            <h3>Step 1: Add Browser Source</h3>
            <ol>
                <li>In OBS, click the <strong>+</strong> button under Sources</li>
                <li>Select <strong>Browser</strong> and name it "DartStream Score Bug"</li>
                <li>Click <strong>OK</strong></li>
            </ol>
            
            <h3>Step 2: Configure Browser Source</h3>
            <ol>
                <li><strong>URL:</strong> Copy and paste your score bug page URL</li>
                <li><strong>Width:</strong> 1920</li>
                <li><strong>Height:</strong> 1080</li>
                <li>Check ? <strong>Shutdown source when not visible</strong></li>
                <li>Check ? <strong>Refresh browser when scene becomes active</strong></li>
                <li>Click <strong>OK</strong></li>
            </ol>
            
            <h3>Step 3: Add Chroma Key Filter</h3>
            <ol>
                <li>Right-click the Browser Source</li>
                <li>Select <strong>Filters</strong></li>
                <li>Click <strong>+</strong> under Effect Filters</li>
                <li>Select <strong>Chroma Key</strong></li>
                <li><strong>Key Color Type:</strong> Green</li>
                <li><strong>Similarity:</strong> 400-500</li>
                <li><strong>Smoothness:</strong> 80-100</li>
                <li>Click <strong>Close</strong></li>
            </ol>
            
            <h3>Step 4: Position & Resize</h3>
            <ol>
                <li>The green background will now be transparent</li>
                <li>Only the score bug and ads will be visible</li>
                <li>Drag and resize in OBS to position on your stream</li>
                <li>Use the score bug settings to adjust the overlay appearance</li>
            </ol>
            
            <p style="margin-top: 20px; padding: 10px; background: rgba(250, 204, 21, 0.1); border-radius: 5px; border-left: 4px solid #facc15;">
                <strong>?? Tip:</strong> The green background (<code>#00ff00</code>) is specifically designed for chroma keying. Make sure to use the Chroma Key filter in OBS to remove it!
            </p>
            
            <button class="obs-close-btn" onclick="closeOBSSetup()">Close</button>
        </div>
    </div>

    <div class="score-bug-overlay">
        <!-- Resize Handles -->
        <div class="resize-handle corner resize-nw"></div>
        <div class="resize-handle corner resize-ne"></div>
        <div class="resize-handle corner resize-sw"></div>
        <div class="resize-handle corner resize-se"></div>
        <div class="resize-handle edge resize-n"></div>
        <div class="resize-handle edge resize-s"></div>
        <div class="resize-handle edge resize-e"></div>
        <div class="resize-handle edge resize-w"></div>
        
        <div class="score-bug-content">
        <!-- Match Header -->
        <div class="match-header" title="Drag to move | Click to edit">
            <div class="match-title" id="matchFormat"></div>
        </div>

        <!-- Players Container -->
        <div class="players-container">
            <!-- Column Headers -->
            <div class="column-headers">
                <div class="column-header empty" data-col="0"></div>
                <div class="column-header empty" data-col="1">NAME</div>
                <div class="column-header empty" data-col="2"></div>
                <div class="column-header" data-col="3">SETS</div>
                <div class="column-header" data-col="4">LEGS</div>
                <div class="column-header" data-col="5">AVG</div>
                <div class="column-header" data-col="6">DARTS</div>
                <div class="column-header" data-col="7">SCORE</div>
                <div class="column-header empty" data-col="8"></div>
            </div>

            <!-- Home Player -->
            <div class="player-row" id="homePlayer">
                <div class="flag-container" id="homeFlagContainer"></div>
                <div class="player-name" id="homeName">Home</div>
                <div class="turn-indicator start" id="homeIndicator"></div>
                <div class="stat-group">
                    <span class="stat-value" id="homeSets">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="homeLegs">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="homeAverage">0.00</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="homeDarts">0</span>
                </div>
                <div class="score-box">
                    <span class="score-value" id="homeScore">501</span>
                    <div class="shot-display" id="homeShot"></div>
                </div>
                <div class="active-arrow"></div>
            </div>

            <!-- Away Player -->
            <div class="player-row" id="awayPlayer">
                <div class="flag-container" id="awayFlagContainer"></div>
                <div class="player-name" id="awayName">Away</div>
                <div class="turn-indicator inactive" id="awayIndicator"></div>
                <div class="stat-group">
                    <span class="stat-value" id="awaySets">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="awayLegs">0</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="awayAverage">0.00</span>
                </div>
                <div class="stat-group">
                    <span class="stat-value" id="awayDarts">0</span>
                </div>
                <div class="score-box">
                    <span class="score-value" id="awayScore">501</span>
                    <div class="shot-display" id="awayShot"></div>
                </div>
                <div class="active-arrow"></div>
            </div>
        </div>

        <!-- Footer -->
        <div class="score-bug-footer">
            <div class="footer-section" id="footerGroup"></div>
            <div class="footer-section" id="footerEvent"></div>
            <div class="footer-section" id="footerFormat"></div>
        </div>
        </div>
    </div>

    <!-- Advertisement Bar -->
    <div id="adBar" class="ad-bar">
        <!-- Resize Handles for Ad Bar -->
        <div class="resize-handle corner resize-nw"></div>
        <div class="resize-handle corner resize-ne"></div>
        <div class="resize-handle corner resize-sw"></div>
        <div class="resize-handle corner resize-se"></div>
        <div class="resize-handle edge resize-n"></div>
        <div class="resize-handle edge resize-s"></div>
        <div class="resize-handle edge resize-e"></div>
        <div class="resize-handle edge resize-w"></div>
        
        <div class="ad-content">
            <img id="adImage" class="ad-image ad-image-hidden" alt="Advertisement">
            <div id="adPlaceholder" class="ad-placeholder">Advertisement Space</div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

        let supabaseClient = null;
        let subscription = null;
        let lastHomeScore = null;
        let lastAwayScore = null;
        let currentDisplayPlayer = 'home';
        let currentGameCode = null; // Track current game code for auto-save

        // Resize functionality
        function initResize() {
            const scoreBug = document.querySelector('.score-bug-overlay');
            const handles = scoreBug.querySelectorAll('.resize-handle');
            
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startWidth, startHeight, startLeft, startTop;

            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    isResizing = true;
                    currentHandle = this;
                    
                    const rect = scoreBug.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = rect.width;
                    startHeight = rect.height;
                    
                    const transform = window.getComputedStyle(scoreBug).transform;
                    const matrix = new DOMMatrix(transform);
                    startLeft = rect.left + rect.width / 2;
                    startTop = rect.top + rect.height / 2;
                    
                    e.preventDefault();
                    e.stopPropagation();
                });
            });

            document.addEventListener('mousemove', function(e) {
                if (!isResizing) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                if (currentHandle.classList.contains('resize-e') || currentHandle.classList.contains('resize-se') || currentHandle.classList.contains('resize-ne')) {
                    newWidth = startWidth + dx;
                }
                if (currentHandle.classList.contains('resize-w') || currentHandle.classList.contains('resize-sw') || currentHandle.classList.contains('resize-nw')) {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx / 2;
                }
                if (currentHandle.classList.contains('resize-s') || currentHandle.classList.contains('resize-se') || currentHandle.classList.contains('resize-sw')) {
                    newHeight = startHeight + dy;
                }
                if (currentHandle.classList.contains('resize-n') || currentHandle.classList.contains('resize-ne') || currentHandle.classList.contains('resize-nw')) {
                    newHeight = startHeight - dy;
                    newTop = startTop + dy / 2;
                }

                // Apply minimum constraints
                if (newWidth < 500) newWidth = 500;
                if (newHeight < 200) newHeight = 200;

                scoreBug.style.width = newWidth + 'px';
                scoreBug.style.height = newHeight + 'px';
                scoreBug.style.left = newLeft + 'px';
                scoreBug.style.top = newTop + 'px';
            });

            document.addEventListener('mouseup', function() {
                isResizing = false;
                currentHandle = null;
            });
        }

        // Initialize resize on page load
        window.addEventListener('DOMContentLoaded', initResize);

        // Draggable functionality
        function initDraggable() {
            const scoreBug = document.querySelector('.score-bug-overlay');
            const header = document.querySelector('.match-header');
            
            let isDragging = false;
            let hasMoved = false;
            let startX, startY, startLeft, startTop;

            header.addEventListener('mousedown', function(e) {
                isDragging = true;
                hasMoved = false;
                
                startX = e.clientX;
                startY = e.clientY;
                
                // Get current position
                const rect = scoreBug.getBoundingClientRect();
                startLeft = rect.left + rect.width / 2;
                startTop = rect.top + rect.height / 2;
                
                e.preventDefault();
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                // Only start dragging if moved more than 5 pixels
                if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                    hasMoved = true;
                    header.style.cursor = 'grabbing';
                    
                    const newLeft = startLeft + dx;
                    const newTop = startTop + dy;

                    scoreBug.style.left = newLeft + 'px';
                    scoreBug.style.top = newTop + 'px';
                }
            });

            document.addEventListener('mouseup', function(e) {
                if (isDragging) {
                    isDragging = false;
                    header.style.cursor = 'grab';
                    
                    // Only toggle settings if we didn't drag
                    if (!hasMoved && e.target.closest('.match-header')) {
                        toggleSettings();
                    }
                }
            });
        }

        // Initialize draggable on page load
        window.addEventListener('DOMContentLoaded', initDraggable);

        async function connectWithCode() {
            const code = document.getElementById('pairingCode').value.trim();
            
            if (code.length !== 4) {
                alert('Please enter a 4-digit code');
                return;
            }

            const supabaseUrl = 'https://kswwbqumgsdissnwuiab.supabase.co';
            const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtzd3dicXVtZ3NkaXNzbnd1aWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODMwNTIsImV4cCI6MjA4MDA1OTA1Mn0.b-z8JqL1dBYJcrrzSt7u6VAaFAtTOl1vqqtFFgHkJ50';

            try {
                console.log('ðŸ”Œ Attempting to connect with code:', code);
                currentGameCode = code; // Save the game code for auto-save
                supabaseClient = createClient(supabaseUrl, supabaseKey);
                
                const { data, error } = await supabaseClient
                    .from('game_states')
                    .select('*')
                    .eq('game_id', code)
                    .maybeSingle();

                if (error) {
                    console.error('? Query error:', error);
                    throw error;
                }

                if (!data) {
                    console.warn('?? No game found with code:', code);
                    alert('No active game found with code: ' + code + '.\n\nMake sure:\n1. The scoring app has started a match\n2. You entered the correct 4-digit code');
                    return;
                }

                console.log('? Found game data:', data);

                document.getElementById('connectionStatus').textContent = '? Connected';
                document.getElementById('connectionStatus').style.color = '#10b981';

                await subscribeToGame(code);
                if (data?.game_state) {
                    console.log('?? Updating score bug with initial state');
                    updateScoreBug(data.game_state);
                }
            } catch (error) {
                console.error('? Connection error:', error);
                console.error('Error details:', error.message, error.code);
                
                let errorMessage = 'Failed to connect to the scoring app.\n\n';
                
                if (error.message && error.message.includes('406')) {
                    errorMessage += 'Database query error. The game_states table might need to be set up correctly.\n\n';
                    errorMessage += 'Please check the Supabase console to ensure the table exists.';
                } else if (error.code === 'PGRST116') {
                    errorMessage += 'No game found with code: ' + code;
                } else {
                    errorMessage += 'Error: ' + (error.message || 'Unknown error');
                }
                
                alert(errorMessage);
            }
        }

        async function subscribeToGame(gameId) {
            console.log('?? Subscribing to game updates for code:', gameId);
            subscription = supabaseClient
                .channel('game-updates')
                .on('postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'game_states',
                        filter: `game_id=eq.${gameId}`
                    },
                    (payload) => {
                        console.log('?? Update received:', payload);
                        if (payload.new?.game_state) {
                            updateScoreBug(payload.new.game_state);
                        }
                    }
                )
                .subscribe((status) => {
                    console.log('?? Subscription status:', status);
                    if (status === 'SUBSCRIBED') {
                        document.getElementById('connectionStatus').textContent = '? Connected - Live';
                        console.log('? Successfully subscribed to real-time updates');
                    }
                });
        }

        // Auto-save game state to localStorage
        function saveGameState(data) {
            try {
                const gameState = {
                    data: data,
                    timestamp: Date.now(),
                    gameCode: currentGameCode
                };
                localStorage.setItem('dartstream-game-state', JSON.stringify(gameState));
                console.log('ðŸ’¾ Game state auto-saved');
            } catch (error) {
                console.error('Failed to save game state:', error);
            }
        }

        // Auto-restore game state from localStorage
        function restoreGameState() {
            try {
                const saved = localStorage.getItem('dartstream-game-state');
                if (!saved) return null;

                const gameState = JSON.parse(saved);
                
                // Check if saved state is from within last 24 hours
                const hoursSinceLastSave = (Date.now() - gameState.timestamp) / (1000 * 60 * 60);
                if (hoursSinceLastSave > 24) {
                    console.log('â° Saved game state is older than 24 hours, ignoring');
                    localStorage.removeItem('dartstream-game-state');
                    return null;
                }

                console.log('ðŸ“‚ Found saved game state from', new Date(gameState.timestamp).toLocaleString());
                return gameState;
            } catch (error) {
                console.error('Failed to restore game state:', error);
                return null;
            }
        }

        function updateScoreBug(data) {
            console.log('Score bug received update:', data);

            // Auto-save the game state
            saveGameState(data);

            // Update player names from new structure
            if (data.player1?.name) {
                updatePlayerName('home', data.player1.name);
            }
            if (data.player2?.name) {
                updatePlayerName('away', data.player2.name);
            }

            // Update scores with animation
            if (data.player1?.score !== undefined) {
                const homeScoreEl = document.getElementById('homeScore');
                const newScore = data.player1.score;
                
                // Check for checkout first (when lastCheckout exists)
                if (data.player1?.lastCheckout) {
                    showCheckoutAnimation('home', data.player1.lastCheckout.score, data.player1.lastCheckout.darts, newScore);
                } else if (newScore === 0 && lastHomeScore !== 0) {
                    // Player just reached 0, show 0 in yellow (waiting for darts input)
                    homeScoreEl.textContent = '0';
                    homeScoreEl.style.color = '#facc15';
                    homeScoreEl.style.opacity = '1';
                } else if (lastHomeScore !== null && lastHomeScore !== newScore) {
                    // Normal score change
                    homeScoreEl.style.color = 'white';
                    const scoreEntered = lastHomeScore - newScore;
                    if (scoreEntered > 0) {
                        showScoreAnimation('home', scoreEntered, newScore);
                    } else {
                        // Score went up (bust), just update
                        homeScoreEl.textContent = newScore;
                    }
                } else {
                    homeScoreEl.style.color = 'white';
                    homeScoreEl.textContent = newScore;
                }
                
                lastHomeScore = newScore;
            }

            if (data.player2?.score !== undefined) {
                const awayScoreEl = document.getElementById('awayScore');
                const newScore = data.player2.score;
                
                // Check for checkout first (when lastCheckout exists)
                if (data.player2?.lastCheckout) {
                    showCheckoutAnimation('away', data.player2.lastCheckout.score, data.player2.lastCheckout.darts, newScore);
                } else if (newScore === 0 && lastAwayScore !== 0) {
                    // Player just reached 0, show 0 in yellow (waiting for darts input)
                    awayScoreEl.textContent = '0';
                    awayScoreEl.style.color = '#facc15';
                    awayScoreEl.style.opacity = '1';
                } else if (lastAwayScore !== null && lastAwayScore !== newScore) {
                    // Normal score change
                    awayScoreEl.style.color = 'white';
                    const scoreEntered = lastAwayScore - newScore;
                    if (scoreEntered > 0) {
                        showScoreAnimation('away', scoreEntered, newScore);
                    } else {
                        // Score went up (bust), just update
                        awayScoreEl.textContent = newScore;
                    }
                } else {
                    awayScoreEl.style.color = 'white';
                    awayScoreEl.textContent = newScore;
                }
                
                lastAwayScore = newScore;
            }

            // Update active player highlight
            const homeSection = document.getElementById('homePlayer');
            const awaySection = document.getElementById('awayPlayer');
            if (data.player1?.isActive) {
                homeSection.classList.add('active');
                awaySection.classList.remove('active');
            } else if (data.player2?.isActive) {
                awaySection.classList.add('active');
                homeSection.classList.remove('active');
            }

            // Update averages
            if (data.player1?.matchAvg !== undefined) {
                document.getElementById('homeAverage').textContent = data.player1.matchAvg.toFixed(2);
            }
            if (data.player2?.matchAvg !== undefined) {
                document.getElementById('awayAverage').textContent = data.player2.matchAvg.toFixed(2);
            }

            // Update sets and legs
            if (data.player1?.setWins !== undefined) {
                document.getElementById('homeSets').textContent = data.player1.setWins;
            }
            if (data.player2?.setWins !== undefined) {
                document.getElementById('awaySets').textContent = data.player2.setWins;
            }

            if (data.player1?.legWins !== undefined) {
                document.getElementById('homeLegs').textContent = data.player1.legWins;
            }
            if (data.player2?.legWins !== undefined) {
                document.getElementById('awayLegs').textContent = data.player2.legWins;
            }
        }
        
        // Show checkout animation (when player wins a leg)
        function showCheckoutAnimation(player, checkoutScore, dartsUsed, newScore) {
            const shotDisplay = document.getElementById(player === 'home' ? 'homeShot' : 'awayShot');
            const scoreEl = document.getElementById(player === 'home' ? 'homeScore' : 'awayScore');
            
            // 0 is already showing in yellow from the initial checkout, now show checkout overlay
            shotDisplay.textContent = `${checkoutScore} (${dartsUsed})`;
            shotDisplay.classList.add('show');
            scoreEl.style.opacity = '0';
            
            // After 3 seconds, fade out the checkout and show the new score (501 or starting score)
            setTimeout(() => {
                shotDisplay.classList.remove('show');
                scoreEl.style.color = 'white';
                scoreEl.textContent = newScore;
                scoreEl.style.opacity = '1';
            }, 3000);
        }
        
        // Show score animation overlay
        function showScoreAnimation(player, scoreEntered, finalScore) {
            const shotDisplay = document.getElementById(player === 'home' ? 'homeShot' : 'awayShot');
            const scoreEl = document.getElementById(player === 'home' ? 'homeScore' : 'awayScore');
            
            // Show the score entered
            shotDisplay.textContent = scoreEntered;
            shotDisplay.classList.add('show');
            
            // Hide the current score temporarily
            scoreEl.style.opacity = '0';
            
            // After 2 seconds, fade out the score entered and show the remaining score
            setTimeout(() => {
                shotDisplay.classList.remove('show');
                scoreEl.textContent = finalScore;
                scoreEl.style.opacity = '1';
            }, 2000);
        }

        window.connectWithCode = connectWithCode;

        // Update player name with flag
        function updatePlayerName(player, name) {
            const flag = sessionStorage.getItem(`scoreboard-${player}-flag`) || '';
            const nameElement = document.getElementById(`${player}Name`);
            const flagContainer = document.getElementById(`${player}FlagContainer`);
            
            // Clear flag container
            flagContainer.innerHTML = '';
            
            // Add flag image if selected
            if (flag) {
                const flagImg = document.createElement('img');
                // Use score-bug-app path for gh-pages deployment
                flagImg.src = `score-bug-app/${flag}`;
                flagImg.alt = 'Flag';
                flagImg.className = 'flag-icon';
                flagContainer.appendChild(flagImg);
            }
            
            // Update player name (text only)
            nameElement.textContent = name.toUpperCase();
        }

        // Settings Panel Functions
        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const scoreBug = document.querySelector('.score-bug-overlay');
            const isOpening = panel.classList.contains('hidden');
            
            panel.classList.toggle('hidden');
            
            if (isOpening) {
                // Entering settings mode - enable resize
                scoreBug.classList.add('resize-mode');
                showResizeModeIndicator();
            } else {
                // Exiting settings mode - check if we should keep resize mode
                const keepResizeMode = document.getElementById('keepResizeMode').checked;
                if (!keepResizeMode) {
                    scoreBug.classList.remove('resize-mode');
                    hideResizeModeIndicator();
                }
                // If keepResizeMode is true, leave resize mode active
            }
        }

        function showResizeModeIndicator() {
            let indicator = document.getElementById('resizeModeIndicator');
            if (!indicator) {
                indicator = document.createElement('div');
                indicator.id = 'resizeModeIndicator';
                indicator.className = 'resize-mode-indicator';
                indicator.textContent = '?? Resize Mode Active - Drag corners/edges to resize';
                document.body.appendChild(indicator);
            }
        }

        function hideResizeModeIndicator() {
            const indicator = document.getElementById('resizeModeIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // Load saved settings from sessionStorage
        function loadSettings() {
            const savedHeader = sessionStorage.getItem('score-bug-header');
            const savedGroup = sessionStorage.getItem('score-bug-footer-group');
            const savedEvent = sessionStorage.getItem('score-bug-footer-event');
            const savedFormat = sessionStorage.getItem('score-bug-footer-format');
            const savedHomeFlag = sessionStorage.getItem('score-bug-home-flag');
            const savedAwayFlag = sessionStorage.getItem('score-bug-away-flag');
            
            if (savedHeader !== null) {
                document.getElementById('matchFormat').textContent = savedHeader;
                document.getElementById('headerText').value = savedHeader;
            }
            if (savedGroup !== null) {
                document.getElementById('footerGroup').textContent = savedGroup;
                document.getElementById('footerGroupInput').value = savedGroup;
            }
            if (savedEvent !== null) {
                document.getElementById('footerEvent').textContent = savedEvent;
                document.getElementById('footerEventInput').value = savedEvent;
            }
            if (savedFormat !== null) {
                document.getElementById('footerFormat').textContent = savedFormat;
                document.getElementById('footerFormatInput').value = savedFormat;
            }
            if (savedHomeFlag !== null) {
                document.getElementById('homeFlag').value = savedHomeFlag;
            }
            if (savedAwayFlag !== null) {
                document.getElementById('awayFlag').value = savedAwayFlag;
            }
            
            // Load saved score bug dimensions
            const savedWidth = sessionStorage.getItem('score-bug-width');
            const savedHeight = sessionStorage.getItem('score-bug-height');
            const savedLeft = sessionStorage.getItem('score-bug-left');
            const savedTop = sessionStorage.getItem('score-bug-top');
            
            const scoreBug = document.querySelector('.score-bug-overlay');
            if (savedWidth) scoreBug.style.width = savedWidth;
            if (savedHeight) scoreBug.style.height = savedHeight;
            if (savedLeft) scoreBug.style.left = savedLeft;
            if (savedTop) scoreBug.style.top = savedTop;
            
            // Load resize mode setting
            const keepResizeMode = sessionStorage.getItem('keep-resize-mode') === 'true';
            document.getElementById('keepResizeMode').checked = keepResizeMode;
            
            // Apply resize mode if it was kept active
            if (keepResizeMode) {
                scoreBug.classList.add('resize-mode');
                showResizeModeIndicator();
            }
            
            // Load column visibility settings
            loadColumnVisibility();
        }

        // Load and apply column visibility settings
        function loadColumnVisibility() {
            const scoreBugOverlay = document.querySelector('.score-bug-overlay');
            
            // Load saved preferences (default to checked/visible)
            const showFlags = sessionStorage.getItem('show-flags') !== 'false';
            const showIndicator = sessionStorage.getItem('show-indicator') !== 'false';
            const showSets = sessionStorage.getItem('show-sets') !== 'false';
            const showLegs = sessionStorage.getItem('show-legs') !== 'false';
            const showAvg = sessionStorage.getItem('show-avg') !== 'false';
            const showDarts = sessionStorage.getItem('show-darts') !== 'false';
            const showScore = sessionStorage.getItem('show-score') !== 'false';
            
            // Update checkboxes
            document.getElementById('showFlags').checked = showFlags;
            document.getElementById('showIndicator').checked = showIndicator;
            document.getElementById('showSets').checked = showSets;
            document.getElementById('showLegs').checked = showLegs;
            document.getElementById('showAvg').checked = showAvg;
            document.getElementById('showDarts').checked = showDarts;
            document.getElementById('showScore').checked = showScore;
            
            // Apply visibility classes
            overlay.classList.toggle('hide-flags', !showFlags);
            overlay.classList.toggle('hide-indicator', !showIndicator);
            overlay.classList.toggle('hide-sets', !showSets);
            overlay.classList.toggle('hide-legs', !showLegs);
            overlay.classList.toggle('hide-avg', !showAvg);
            overlay.classList.toggle('hide-darts', !showDarts);
            overlay.classList.toggle('hide-score', !showScore);
        }

        // Save settings when Save button is clicked
        function saveSettings() {
            const headerValue = document.getElementById('headerText').value;
            const groupValue = document.getElementById('footerGroupInput').value;
            const eventValue = document.getElementById('footerEventInput').value;
            const formatValue = document.getElementById('footerFormatInput').value;
            const homeFlagValue = document.getElementById('homeFlag').value;
            const awayFlagValue = document.getElementById('awayFlag').value;
            
            // Update display
            document.getElementById('matchFormat').textContent = headerValue;
            document.getElementById('footerGroup').textContent = groupValue;
            document.getElementById('footerEvent').textContent = eventValue;
            document.getElementById('footerFormat').textContent = formatValue;
            
            // Save to sessionStorage (persists only while browser is open)
            sessionStorage.setItem('score-bug-header', headerValue);
            sessionStorage.setItem('score-bug-footer-group', groupValue);
            sessionStorage.setItem('score-bug-footer-event', eventValue);
            sessionStorage.setItem('score-bug-footer-format', formatValue);
            sessionStorage.setItem('score-bug-home-flag', homeFlagValue);
            sessionStorage.setItem('score-bug-away-flag', awayFlagValue);
            
            // Update player names with flags
            const homeName = document.getElementById('homeName').textContent.trim();
            const awayName = document.getElementById('awayName').textContent.trim();
            updatePlayerName('home', homeName);
            updatePlayerName('away', awayName);
            
            // Save column visibility settings
            const showFlags = document.getElementById('showFlags').checked;
            const showIndicator = document.getElementById('showIndicator').checked;
            const showSets = document.getElementById('showSets').checked;
            const showLegs = document.getElementById('showLegs').checked;
            const showAvg = document.getElementById('showAvg').checked;
            const showDarts = document.getElementById('showDarts').checked;
            const showScore = document.getElementById('showScore').checked;
            
            sessionStorage.setItem('show-flags', showFlags);
            sessionStorage.setItem('show-indicator', showIndicator);
            sessionStorage.setItem('show-sets', showSets);
            sessionStorage.setItem('show-legs', showLegs);
            sessionStorage.setItem('show-avg', showAvg);
            sessionStorage.setItem('show-darts', showDarts);
            sessionStorage.setItem('show-score', showScore);
            
            // Apply visibility
            loadColumnVisibility();
            
            // Save ad settings
            saveAdSettings();
            
            // Save resize mode setting
            const keepResizeMode = document.getElementById('keepResizeMode').checked;
            sessionStorage.setItem('keep-resize-mode', keepResizeMode);
            
            // Save current score bug size
            const scoreBug = document.querySelector('.score-bug-overlay');
            const currentWidth = scoreBug.style.width;
            const currentHeight = scoreBug.style.height;
            const currentLeft = scoreBug.style.left;
            const currentTop = scoreBug.style.top;
            
            if (currentWidth) sessionStorage.setItem('score-bug-width', currentWidth);
            if (currentHeight) sessionStorage.setItem('score-bug-height', currentHeight);
            if (currentLeft) sessionStorage.setItem('score-bug-left', currentLeft);
            if (currentTop) sessionStorage.setItem('score-bug-top', currentTop);
            
            // Close settings panel (this will check keepResizeMode and conditionally disable resize mode)
            toggleSettings();
        }

        // Advertisement Bar Functions
        let adBarTimeout = null;
        let adBarLocked = false;
        let adEnableTransitions = false;

        function loadAdSettings() {
            const savedAdImage = sessionStorage.getItem('ad-bar-image');
            
            if (savedAdImage) {
                document.getElementById('adImage').src = savedAdImage;
                document.getElementById('adImage').classList.remove('ad-image-hidden');
                document.getElementById('adPlaceholder').classList.add('ad-image-hidden');
                document.getElementById('adPreview').src = savedAdImage;
                document.getElementById('adPreview').classList.add('visible');
            }
        }

        function toggleAdBar() {
            if (document.body.classList.contains('ad-visible')) {
                hideAdBar();
            } else {
                showAdBar();
            }
        }

        function showAdBar() {
            document.body.classList.remove('ad-hidden');
            document.body.classList.add('ad-visible');
            
            // Auto-hide after 10 seconds only if not locked
            if (!adBarLocked) {
                if (adBarTimeout) clearTimeout(adBarTimeout);
                adBarTimeout = setTimeout(() => {
                    hideAdBar();
                }, 10000);
            }
        }

        function hideAdBar() {
            document.body.classList.remove('ad-visible');
            document.body.classList.add('ad-hidden');
            
            if (adBarTimeout) {
                clearTimeout(adBarTimeout);
                adBarTimeout = null;
            }
        }

        function toggleAdLock() {
            const lockBtn = document.getElementById('adLockBtn');
            const adBar = document.getElementById('adBar');
            
            adBarLocked = !adBarLocked;
            
            if (adBarLocked) {
                // Lock is ON - ad will stay visible
                lockBtn.classList.add('locked');
                lockBtn.textContent = '?? Locked';
                
                // Cancel any existing timeout
                if (adBarTimeout) {
                    clearTimeout(adBarTimeout);
                    adBarTimeout = null;
                }
            } else {
                // Lock is OFF - ad will hide after 3 seconds
                lockBtn.classList.remove('locked');
                lockBtn.textContent = '?? Unlock';
                
                // If ad is currently showing, hide it after 3 seconds
                if (adBar.classList.contains('active')) {
                    if (adBarTimeout) clearTimeout(adBarTimeout);
                    adBarTimeout = setTimeout(() => {
                        hideAdBar();
                    }, 3000);
                }
            }
        }

        // Handle ad image upload
        document.getElementById('adImageUpload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const imageData = event.target.result;
                    
                    // Update preview
                    document.getElementById('adPreview').src = imageData;
                    document.getElementById('adPreview').classList.add('visible');
                    
                    // Update ad bar image
                    document.getElementById('adImage').src = imageData;
                    document.getElementById('adImage').classList.remove('ad-image-hidden');
                    document.getElementById('adPlaceholder').classList.add('ad-image-hidden');
                    
                    // Save to sessionStorage
                    sessionStorage.setItem('ad-bar-image', imageData);
                };
                reader.readAsDataURL(file);
            }
        });

        // Load settings on page load
        loadSettings();
        loadAdSettings();

        // Check for saved game state and offer to restore
        function checkSavedGameState() {
            const savedState = restoreGameState();
            if (savedState && savedState.data) {
                const timeSaved = new Date(savedState.timestamp).toLocaleTimeString();
                const shouldRestore = confirm(
                    `Found a saved game from ${timeSaved}.\n\n` +
                    `Players: ${savedState.data.player1?.name || 'Player 1'} vs ${savedState.data.player2?.name || 'Player 2'}\n` +
                    `Scores: ${savedState.data.player1?.score || 0} - ${savedState.data.player2?.score || 0}\n\n` +
                    `Would you like to restore this game?`
                );

                if (shouldRestore) {
                    console.log('ðŸ“‚ Restoring saved game state');
                    currentGameCode = savedState.gameCode;
                    
                    // Update the display with saved state
                    updateScoreBug(savedState.data);
                    
                    // Show connection status
                    document.getElementById('connectionStatus').textContent = 'ðŸ“‚ Restored from save';
                    document.getElementById('connectionStatus').style.color = '#10b981';
                    
                    // If we have a game code, try to reconnect
                    if (savedState.gameCode) {
                        document.getElementById('pairingCode').value = savedState.gameCode;
                        setTimeout(() => {
                            console.log('ðŸ”„ Attempting to reconnect to game...');
                            connectWithCode();
                        }, 1000);
                    }
                } else {
                    // User declined, clear the saved state
                    localStorage.removeItem('dartstream-game-state');
                }
            }
        }

        // Check for auto-connect from match central
        function checkAutoConnect() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoConnectCode = urlParams.get('autoconnect');
            
            if (autoConnectCode && autoConnectCode.length === 4) {
                // Auto-fill the code and connect
                document.getElementById('pairingCode').value = autoConnectCode;
                setTimeout(() => {
                    connectWithCode();
                }, 500);
            }
        }

        // Run checks on page load
        checkSavedGameState();
        checkAutoConnect();

        // Ad Settings Variables
        let adTransitionType = 'slide-left';
        let adTransitionDuration = 1;
        let adResizeEnabled = false;

        // Toggle Ad Function
        function toggleAd() {
            const adBar = document.getElementById('adBar');
            
            if (document.body.classList.contains('ad-visible')) {
                // Hide ad
                document.body.classList.remove('ad-visible');
                document.body.classList.add('ad-hidden');
            } else {
                // Show ad
                document.body.classList.remove('ad-hidden');
                document.body.classList.add('ad-visible');
            }
        }

        // Toggle Ad Settings Panel
        function toggleAdSettings() {
            const panel = document.getElementById('adSettingsPanel');
            const adBar = document.getElementById('adBar');
            const isOpening = panel.classList.contains('hidden');
            
            panel.classList.toggle('hidden');
            
            if (isOpening) {
                // Load current settings
                loadAdSettingsPanel();
            }
        }

        // Load Ad Settings
        function loadAdSettingsPanel() {
            const savedTransitionType = sessionStorage.getItem('ad-transition-type') || 'slide-left';
            const savedTransitionDuration = sessionStorage.getItem('ad-transition-duration') || '1';
            const savedEnableTransitions = sessionStorage.getItem('ad-enable-transitions') === 'true';
            
            document.getElementById('adTransitionType').value = savedTransitionType;
            document.getElementById('adTransitionDuration').value = savedTransitionDuration;
            document.getElementById('adEnableTransitions').checked = savedEnableTransitions;
            document.getElementById('adResizeMode').checked = adResizeEnabled;
            
            adTransitionType = savedTransitionType;
            adTransitionDuration = parseFloat(savedTransitionDuration);
            adEnableTransitions = savedEnableTransitions;
        }

        // Save Ad Settings
        function saveAdSettingsPanel() {
            const adBar = document.getElementById('adBar');
            
            adTransitionType = document.getElementById('adTransitionType').value;
            adTransitionDuration = parseFloat(document.getElementById('adTransitionDuration').value);
            adEnableTransitions = document.getElementById('adEnableTransitions').checked;
            adResizeEnabled = document.getElementById('adResizeMode').checked;
            
            // Save to sessionStorage
            sessionStorage.setItem('ad-transition-type', adTransitionType);
            sessionStorage.setItem('ad-transition-duration', adTransitionDuration);
            sessionStorage.setItem('ad-enable-transitions', adEnableTransitions);
            sessionStorage.setItem('ad-resize-enabled', adResizeEnabled);
            
            // Save current ad box dimensions
            const currentWidth = adBar.style.width;
            const currentHeight = adBar.style.height;
            const currentLeft = adBar.style.left;
            const currentTop = adBar.style.top;
            
            if (currentWidth) sessionStorage.setItem('ad-width', currentWidth);
            if (currentHeight) sessionStorage.setItem('ad-height', currentHeight);
            if (currentLeft) sessionStorage.setItem('ad-left', currentLeft);
            if (currentTop) sessionStorage.setItem('ad-top', currentTop);
            
            // Apply resize mode
            if (adResizeEnabled) {
                adBar.classList.add('resize-mode');
            } else {
                adBar.classList.remove('resize-mode');
            }
            
            // Update transition class and duration only if transitions are enabled
            adBar.classList.remove('slide-left', 'slide-right', 'slide-up', 'slide-down', 'fade');
            if (adEnableTransitions) {
                adBar.classList.add(adTransitionType);
                adBar.style.transition = `all ${adTransitionDuration}s ease-in-out`;
            } else {
                adBar.style.transition = 'none';
            }
            
            alert('Ad settings saved!');
        }

        // Load Ad Image
        function loadAdImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const adImage = document.getElementById('adImage');
                    const adPlaceholder = document.getElementById('adPlaceholder');
                    const adPreview = document.getElementById('adPreview');
                    
                    adImage.src = e.target.result;
                    adImage.classList.remove('ad-image-hidden');
                    adPlaceholder.classList.add('ad-image-hidden');
                    
                    // Update preview in settings
                    adPreview.src = e.target.result;
                    adPreview.classList.add('visible');
                    
                    // Save to sessionStorage
                    sessionStorage.setItem('ad-bar-image', e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // Initialize ad draggable and resizable
        function initAdDraggable() {
            const adBar = document.getElementById('adBar');
            let isDragging = false;
            let startX, startY, startLeft, startTop;

            const handleMouseMove = function(e) {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                const newLeft = startLeft + deltaX;
                const newTop = startTop + deltaY;
                
                adBar.style.left = newLeft + 'px';
                adBar.style.top = newTop + 'px';
                adBar.style.transform = 'none';
            };

            const handleMouseUp = function() {
                if (isDragging) {
                    isDragging = false;
                    adBar.style.cursor = '';
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
            };
            
            adBar.addEventListener('mousedown', function(e) {
                if (!adResizeEnabled) return;
                if (e.target.classList.contains('resize-handle')) return;
                if (e.target !== adBar && !e.target.classList.contains('ad-content') && !e.target.classList.contains('ad-placeholder') && !e.target.classList.contains('ad-image')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                
                const rect = adBar.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                
                adBar.style.cursor = 'grabbing';
                e.preventDefault();
                
                document.addEventListener('mousemove', handleMouseMove);
                document.addEventListener('mouseup', handleMouseUp);
            });
        }

        // Initialize ad resize functionality
        function initAdResize() {
            const adBar = document.getElementById('adBar');
            const handles = adBar.querySelectorAll('.resize-handle');
            
            let isResizing = false;
            let currentHandle = null;
            let startX, startY, startWidth, startHeight, startLeft, startTop;

            const handleMouseMove = function(e) {
                if (!isResizing) return;

                const dx = e.clientX - startX;
                const dy = e.clientY - startY;
                
                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                if (currentHandle.classList.contains('resize-e') || currentHandle.classList.contains('resize-se') || currentHandle.classList.contains('resize-ne')) {
                    newWidth = startWidth + dx;
                }
                if (currentHandle.classList.contains('resize-w') || currentHandle.classList.contains('resize-sw') || currentHandle.classList.contains('resize-nw')) {
                    newWidth = startWidth - dx;
                    newLeft = startLeft + dx;
                }
                if (currentHandle.classList.contains('resize-s') || currentHandle.classList.contains('resize-se') || currentHandle.classList.contains('resize-sw')) {
                    newHeight = startHeight + dy;
                }
                if (currentHandle.classList.contains('resize-n') || currentHandle.classList.contains('resize-ne') || currentHandle.classList.contains('resize-nw')) {
                    newHeight = startHeight - dy;
                    newTop = startTop + dy;
                }

                // Apply minimum constraints
                if (newWidth < 150) newWidth = 150;
                if (newHeight < 100) newHeight = 100;

                adBar.style.width = newWidth + 'px';
                adBar.style.height = newHeight + 'px';
                adBar.style.left = newLeft + 'px';
                adBar.style.top = newTop + 'px';
                adBar.style.transform = 'none';
            };

            const handleMouseUp = function() {
                if (isResizing) {
                    isResizing = false;
                    currentHandle = null;
                    document.removeEventListener('mousemove', handleMouseMove);
                    document.removeEventListener('mouseup', handleMouseUp);
                }
            };

            handles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    if (!adResizeEnabled) return;
                    
                    isResizing = true;
                    currentHandle = this;
                    
                    const rect = adBar.getBoundingClientRect();
                    startX = e.clientX;
                    startY = e.clientY;
                    startWidth = rect.width;
                    startHeight = rect.height;
                    startLeft = rect.left;
                    startTop = rect.top;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    document.addEventListener('mousemove', handleMouseMove);
                    document.addEventListener('mouseup', handleMouseUp);
                });
            });
        }

        // Initialize ad on page load
        window.addEventListener('DOMContentLoaded', function() {
            initAdDraggable();
            initAdResize();
            
            // Apply saved settings
            const savedTransitionType = sessionStorage.getItem('ad-transition-type') || 'slide-left';
            const savedTransitionDuration = sessionStorage.getItem('ad-transition-duration') || '1';
            const savedEnableTransitions = sessionStorage.getItem('ad-enable-transitions') === 'true';
            const savedResizeEnabled = sessionStorage.getItem('ad-resize-enabled') === 'true';
            
            const adBar = document.getElementById('adBar');
            adBar.className = 'ad-bar ' + savedTransitionType;
            
            // Only apply transition if enabled
            if (savedEnableTransitions) {
                adBar.style.transition = `all ${savedTransitionDuration}s ease-in-out`;
            } else {
                adBar.style.transition = 'none';
            }
            
            // Load saved ad dimensions
            const savedWidth = sessionStorage.getItem('ad-width');
            const savedHeight = sessionStorage.getItem('ad-height');
            const savedLeft = sessionStorage.getItem('ad-left');
            const savedTop = sessionStorage.getItem('ad-top');
            
            if (savedWidth) adBar.style.width = savedWidth;
            if (savedHeight) adBar.style.height = savedHeight;
            if (savedLeft) adBar.style.left = savedLeft;
            if (savedTop) adBar.style.top = savedTop;
            
            // Apply resize mode if it was enabled
            if (savedResizeEnabled) {
                adBar.classList.add('resize-mode');
                adResizeEnabled = true;
            }
            
            adTransitionType = savedTransitionType;
            adTransitionDuration = parseFloat(savedTransitionDuration);
            adEnableTransitions = savedEnableTransitions;
            
            // Add keyboard controls for fine adjustment
            initAdKeyboardControls();
        });

        // Keyboard controls for ad box positioning
        function initAdKeyboardControls() {
            const adBar = document.getElementById('adBar');
            
            document.addEventListener('keydown', function(e) {
                // Only allow arrow keys when resize mode is enabled and no input is focused
                if (!adResizeEnabled) return;
                if (document.activeElement.tagName === 'INPUT' || 
                    document.activeElement.tagName === 'TEXTAREA' || 
                    document.activeElement.tagName === 'SELECT') return;
                
                const step = e.shiftKey ? 10 : 1; // Hold Shift for larger steps
                const rect = adBar.getBoundingClientRect();
                let currentLeft = parseFloat(adBar.style.left) || rect.left;
                let currentTop = parseFloat(adBar.style.top) || rect.top;
                
                switch(e.key) {
                    case 'ArrowLeft':
                        currentLeft -= step;
                        adBar.style.left = currentLeft + 'px';
                        adBar.style.transform = 'none';
                        e.preventDefault();
                        break;
                    case 'ArrowRight':
                        currentLeft += step;
                        adBar.style.left = currentLeft + 'px';
                        adBar.style.transform = 'none';
                        e.preventDefault();
                        break;
                    case 'ArrowUp':
                        currentTop -= step;
                        adBar.style.top = currentTop + 'px';
                        adBar.style.transform = 'none';
                        e.preventDefault();
                        break;
                    case 'ArrowDown':
                        currentTop += step;
                        adBar.style.top = currentTop + 'px';
                        adBar.style.transform = 'none';
                        e.preventDefault();
                        break;
                }
            });
        }

        window.toggleSettings = toggleSettings;
        window.saveSettings = saveSettings;
        window.toggleAd = toggleAd;
        window.toggleAdSettings = toggleAdSettings;
        window.saveAdSettingsPanel = saveAdSettingsPanel;
        
        // OBS Setup Modal Functions
        function showOBSSetup() {
            document.getElementById('obsModal').classList.add('visible');
        }
        
        function closeOBSSetup() {
            document.getElementById('obsModal').classList.remove('visible');
        }
        
        window.showOBSSetup = showOBSSetup;
        window.closeOBSSetup = closeOBSSetup;
        
        // Initialize controller communication
        let controlChannel = null;
        let authorizedControllers = new Set();
        let scoreBugConnectionCode = null;
        
        function initializeControllerComms() {
            // Generate or load score bug connection code
            scoreBugConnectionCode = localStorage.getItem('score-bug-connection-code');
            if (!scoreBugConnectionCode) {
                scoreBugConnectionCode = Math.floor(1000 + Math.random() * 9000).toString();
                localStorage.setItem('score-bug-connection-code', scoreBugConnectionCode);
            }
            
            // Display the connection code in both locations
            const codeDisplay = document.getElementById('connectionCodeDisplay');
            if (codeDisplay) {
                codeDisplay.textContent = scoreBugConnectionCode;
            }
            const topCodeDisplay = document.getElementById('topConnectionCodeDisplay');
            if (topCodeDisplay) {
                topCodeDisplay.textContent = scoreBugConnectionCode;
            }
            
            // Set up BroadcastChannel for same-browser communication
            controlChannel = new BroadcastChannel('dartstream-control');
            
            controlChannel.addEventListener('message', function(event) {
                handleControllerMessage(event.data);
            });
            
            // Listen for localStorage changes (cross-browser/computer)
            window.addEventListener('storage', function(e) {
                if (e.key && e.key.startsWith('dartstream-control-')) {
                    try {
                        const message = JSON.parse(e.newValue);
                        handleControllerMessage(message);
                    } catch (err) {
                        console.error('Error parsing controller message:', err);
                    }
                }
            });
            
            // Set up Supabase Realtime for remote controller commands
            setupSupabaseControllerChannel();
        }
        
        // Set up Supabase Realtime channel for controller commands
        function setupSupabaseControllerChannel() {
            if (!supabaseClient) return;
            
            const channelName = `controller:${scoreBugConnectionCode}`;
            const controllerChannel = supabaseClient.channel(channelName);
            
            controllerChannel
                .on('broadcast', { event: 'controller-command' }, (payload) => {
                    console.log('Received remote controller command:', payload);
                    handleControllerMessage(payload.payload);
                })
                .subscribe((status) => {
                    console.log('Controller channel status:', status);
                    if (status === 'SUBSCRIBED') {
                        console.log('? Remote controller channel ready');
                    }
                });
        }
        
        // Call initialization
        initializeControllerComms();
        
        // Track last ping time for connection monitoring
        let lastControllerPing = 0;
        
        // Check controller connection status every 10 seconds
        setInterval(function() {
            const indicator = document.getElementById('controllerIndicator');
            if (!indicator) return;
            
            const timeSinceLastPing = Date.now() - lastControllerPing;
            if (timeSinceLastPing > 10000 && authorizedControllers.size > 0) {
                // No ping in 10 seconds, mark as disconnected
                indicator.classList.remove('connected');
                // Clear authorized controllers
                authorizedControllers.clear();
            }
        }, 10000);
        
        // Listen for controller messages
        window.addEventListener('storage', function(e) {
            if (!e.key || !e.key.startsWith('dartstream-controller-')) return;
            
            try {
                const message = JSON.parse(e.newValue);
                handleControllerMessage(message);
            } catch (err) {
                console.error('Error parsing controller message:', err);
            }
        });
        
        function sendToController(message) {
            // Send via BroadcastChannel
            if (controlChannel) {
                controlChannel.postMessage(message);
            }
            
            // Also send via localStorage
            const channel = 'dartstream-response-' + Date.now();
            localStorage.setItem(channel, JSON.stringify(message));
            
            // Send via Supabase for remote communication
            if (supabaseClient && scoreBugConnectionCode) {
                const channelName = `controller:${scoreBugConnectionCode}`;
                const supabaseChannel = supabaseClient.channel(channelName);
                supabaseChannel.send({
                    type: 'broadcast',
                    event: 'controller-response',
                    payload: message
                });
            }
            
            // Clean up
            setTimeout(() => {
                localStorage.removeItem(channel);
            }, 5000);
        }
        
        function handleControllerMessage(message) {
            // Handle ping first to establish connection
            if (message.type === 'ping' && message.scoreBugCode) {
                // Verify the controller has the correct score bug code
                if (message.scoreBugCode === scoreBugConnectionCode) {
                    // Generate a unique controller ID and authorize it
                    const controllerId = 'controller-' + Date.now();
                    authorizedControllers.add(controllerId);
                    lastControllerPing = Date.now();
                    
                    // Update connection indicator
                    const indicator = document.getElementById('controllerIndicator');
                    if (indicator) {
                        indicator.classList.add('connected');
                    }
                    
                    sendToController({
                        type: 'pong',
                        controllerId: controllerId
                    });
                    console.log('Controller connected with ID:', controllerId);
                } else {
                    console.warn('Invalid score bug code from controller');
                }
                return;
            }
            
            // Check if controller is authorized
            if (!message.controllerId || !authorizedControllers.has(message.controllerId)) {
                console.warn('Unauthorized controller message');
                return;
            }
            
            // Update last ping time for any authorized message
            lastControllerPing = Date.now();
            
            // Send acknowledgment
            sendToController({
                type: 'ack',
                controllerId: message.controllerId,
                commandType: message.type
            });
            
            switch(message.type) {
                case 'updateScoreBug':
                    // Update score bug settings
                    if (message.header) {
                        document.getElementById('matchFormat').textContent = message.header;
                        sessionStorage.setItem('score-bug-header', message.header);
                    }
                    if (message.group) {
                        document.getElementById('footerGroup').textContent = message.group;
                        sessionStorage.setItem('score-bug-footer-group', message.group);
                    }
                    if (message.event) {
                        document.getElementById('footerEvent').textContent = message.event;
                        sessionStorage.setItem('score-bug-footer-event', message.event);
                    }
                    if (message.format) {
                        document.getElementById('footerFormat').textContent = message.format;
                        sessionStorage.setItem('score-bug-footer-format', message.format);
                    }
                    
                    // Update column visibility
                    const scoreBugOverlay = document.querySelector('.score-bug-overlay');
                    overlay.classList.toggle('hide-flags', !message.showFlags);
                    overlay.classList.toggle('hide-indicator', !message.showIndicator);
                    overlay.classList.toggle('hide-sets', !message.showSets);
                    overlay.classList.toggle('hide-legs', !message.showLegs);
                    overlay.classList.toggle('hide-avg', !message.showAvg);
                    overlay.classList.toggle('hide-darts', !message.showDarts);
                    overlay.classList.toggle('hide-score', !message.showScore);
                    
                    sessionStorage.setItem('show-flags', message.showFlags);
                    sessionStorage.setItem('show-indicator', message.showIndicator);
                    sessionStorage.setItem('show-sets', message.showSets);
                    sessionStorage.setItem('show-legs', message.showLegs);
                    sessionStorage.setItem('show-avg', message.showAvg);
                    sessionStorage.setItem('show-darts', message.showDarts);
                    sessionStorage.setItem('show-score', message.showScore);
                    break;
                    
                case 'updateAdImage':
                    const adImage = document.getElementById('adImage');
                    const adPlaceholder = document.getElementById('adPlaceholder');
                    adImage.src = message.image;
                    adImage.classList.remove('ad-image-hidden');
                    adPlaceholder.classList.add('ad-image-hidden');
                    sessionStorage.setItem('ad-bar-image', message.image);
                    break;
                    
                case 'toggleAd':
                    toggleAd();
                    break;
                    
                case 'showAd':
                    // Show the ad
                    document.body.classList.remove('ad-hidden');
                    break;
                    
                case 'hideAd':
                    // Hide the ad
                    document.body.classList.add('ad-hidden');
                    break;
                    
                case 'updateAdSettings':
                    const adBar = document.getElementById('adBar');
                    adEnableTransitions = message.enableTransitions;
                    adTransitionType = message.transitionType;
                    adTransitionDuration = parseFloat(message.transitionDuration);
                    
                    sessionStorage.setItem('ad-enable-transitions', message.enableTransitions);
                    sessionStorage.setItem('ad-transition-type', message.transitionType);
                    sessionStorage.setItem('ad-transition-duration', message.transitionDuration);
                    
                    adBar.classList.remove('slide-left', 'slide-right', 'slide-up', 'slide-down', 'fade');
                    if (adEnableTransitions) {
                        adBar.classList.add(adTransitionType);
                        adBar.style.transition = `all ${adTransitionDuration}s ease-in-out`;
                    } else {
                        adBar.style.transition = 'none';
                    }
                    break;
            }
        }
    </script>
    
    </div> <!-- End content-wrapper -->
</body>
</html>

