<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Room Creation Test - Step by Step</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Auth Wall */
        .auth-wall {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.95) 0%, rgba(0,78,137,0.9) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .auth-wall-content {
            text-align: center;
            color: white;
        }

        .auth-wall-card {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255, 107, 53, 0.5);
            border-radius: 16px;
            padding: 3rem 2rem;
            max-width: 450px;
            backdrop-filter: blur(10px);
        }

        .auth-wall-card h2 {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #FF6B35;
        }

        .auth-wall-card p {
            font-size: 1.1rem;
            margin-bottom: 0.8rem;
            color: rgba(255,255,255,0.8);
            line-height: 1.6;
        }

        .auth-buttons-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
        }

        .auth-btn {
            display: inline-block;
            padding: 0.9rem 1.8rem;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .auth-btn.sign-in {
            background: #FF6B35;
            color: white;
        }

        .auth-btn.sign-in:hover {
            background: #ff5520;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .auth-btn.create {
            background: rgba(255, 107, 53, 0.2);
            color: #FF6B35;
            border: 2px solid #FF6B35;
        }

        .auth-btn.create:hover {
            background: rgba(255, 107, 53, 0.35);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.3);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 30px;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }
        .test-section {
            margin-bottom: 25px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
        }
        .test-section h2 {
            font-size: 16px;
            color: #667eea;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .status-icon {
            font-size: 20px;
        }
        .status-icon.pending { color: #ff9800; }
        .status-icon.success { color: #4caf50; }
        .status-icon.error { color: #f44336; }
        .status-icon.skip { color: #9e9e9e; }

        .output {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            word-break: break-all;
        }
        .output.error {
            border-left-color: #f44336;
            background: #ffebee;
        }
        .output.success {
            border-left-color: #4caf50;
            background: #e8f5e9;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        button {
            padding: 12px 24px;
            font-size: 14px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #667eea;
            color: white;
        }
        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-danger:hover {
            background: #da190b;
        }
        .btn-success {
            background: #4caf50;
            color: white;
        }
        .btn-success:hover {
            background: #388e3c;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            margin-bottom: 20px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #4caf50;
            width: 0%;
            transition: width 0.3s;
        }
        .variable-display {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        .variable-display strong {
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Auth Wall (shown if not logged in) -->
    <div id="authWall" class="auth-wall" style="display: none;">
        <div class="auth-wall-content">
            <div class="auth-wall-card">
                <h2>üîê Sign In Required</h2>
                <p>You need to be signed in to test room creation.</p>
                <p>This test requires authentication to verify RLS policies work correctly.</p>
                
                <div class="auth-buttons-container">
                    <a href="../player-account/player-account.html?action=login&return=play-online/test-room-creation" class="auth-btn sign-in">
                        ‚úì Sign In
                    </a>
                    <a href="../player-account/player-account.html?action=register&return=play-online/test-room-creation" class="auth-btn create">
                        + Create Account
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container" id="testContainer" style="display: none;">
        <h1>üß™ Room Creation Test Suite</h1>
        <div style="background: #e3f2fd; padding: 8px; border-radius: 4px; margin-bottom: 15px; font-size: 12px; color: #1565c0;">
            <strong>Version 2.2</strong> - Last Updated: Dec 14, 2025 - Requires Authentication
        </div>
        
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Step 1: Module Loading -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step1Icon">‚è≥</span>
                Step 1: Load Modules
            </h2>
            <div class="output" id="step1Output"></div>
        </div>

        <!-- Step 2: Initialize Supabase -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step2Icon">‚è≥</span>
                Step 2: Initialize Supabase Client
            </h2>
            <div class="output" id="step2Output"></div>
            <div class="variable-display" id="step2Vars"></div>
        </div>

        <!-- Step 3: Initialize GuestAuth -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step3Icon">‚è≥</span>
                Step 3: Initialize Guest Auth
            </h2>
            <div class="output" id="step3Output"></div>
            <div class="variable-display" id="step3Vars"></div>
        </div>

        <!-- Step 4: Get Authenticated User -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step4Icon">‚è≥</span>
                Step 4: Get Authenticated User
            </h2>
            <div class="output" id="step4Output"></div>
            <div class="variable-display" id="step4Vars"></div>
        </div>

        <!-- Step 5: Generate Room Code -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step5Icon">‚è≥</span>
                Step 5: Generate Room Code
            </h2>
            <div class="output" id="step5Output"></div>
            <div class="variable-display" id="step5Vars"></div>
        </div>

        <!-- Step 6: Generate UUID -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step6Icon">‚è≥</span>
                Step 6: Generate UUID
            </h2>
            <div class="output" id="step6Output"></div>
            <div class="variable-display" id="step6Vars"></div>
        </div>

        <!-- Step 7: Create Room in Database -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step7Icon">‚è≥</span>
                Step 7: Insert Room into Database
            </h2>
            <div class="output" id="step7Output"></div>
            <div class="variable-display" id="step7Vars"></div>
        </div>

        <!-- Step 8: Verify Room Created -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="step8Icon">‚è≥</span>
                Step 8: Verify Room in Database
            </h2>
            <div class="output" id="step8Output"></div>
            <div class="variable-display" id="step8Vars"></div>
        </div>

        <!-- Summary -->
        <div class="test-section">
            <h2>
                <span class="status-icon pending" id="summaryIcon">‚è≥</span>
                Test Summary
            </h2>
            <div class="output" id="summaryOutput"></div>
        </div>

        <div class="button-group">
            <button class="btn-primary" id="btnRunFull">‚ñ∂Ô∏è Run Full Test</button>
            <button class="btn-success" id="btnRunStepByStep">üìã Run Step by Step</button>
            <button class="btn-danger" id="btnClear">üóëÔ∏è Clear Logs</button>
        </div>
    </div>

    <script>
        // Initialize buttons after DOM is ready
        async function initializeButtons() {
            const btnRunFull = document.getElementById('btnRunFull');
            const btnRunStepByStep = document.getElementById('btnRunStepByStep');
            const btnClear = document.getElementById('btnClear');
            
            if (btnRunFull) btnRunFull.onclick = () => window.runFullTest();
            if (btnRunStepByStep) btnRunStepByStep.onclick = () => window.runStepByStep();
            if (btnClear) btnClear.onclick = () => window.clearLogs();
            
            console.log('‚úÖ Test page initialized and ready');
        }
        
        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeButtons);
        } else {
            initializeButtons();
        }
        // Wait for DOM to be ready
        function waitForDOM() {
            return new Promise((resolve) => {
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', resolve);
                } else {
                    resolve();
                }
            });
        }

        // Test state
        let testState = {
            supabaseClient: null,
            playerId: null,
            roomCode: null,
            roomId: null,
            insertedData: null,
            verifiedData: null,
            errors: []
        };

        window.testState = testState;

        // Helper function to log to UI
        function log(stepNum, message, type = 'info') {
            const elementId = stepNum === 'summary' ? 'summaryOutput' : `step${stepNum}Output`;
            const output = document.getElementById(elementId);
            
            // Always log to console as fallback
            console.log(`[Step ${stepNum}] ${message}`);
            
            // Only update UI if element exists
            if (output) {
                const timestamp = new Date().toLocaleTimeString();
                const line = `[${timestamp}] ${message}\n`;
                output.textContent += line;
                try {
                    output.scrollTop = output.scrollHeight;
                } catch (e) {
                    // Ignore scroll errors
                }
            }
        }

        function setStatus(stepNum, status) {
            const iconId = `step${stepNum}Icon`;
            const outputId = `step${stepNum}Output`;
            
            const icon = document.getElementById(iconId);
            const output = document.getElementById(outputId);
            
            if (icon) {
                icon.textContent = status === 'success' ? '‚úÖ' : 
                                  status === 'error' ? '‚ùå' : 
                                  status === 'skip' ? '‚äò' : '‚è≥';
                icon.className = `status-icon ${status}`;
            }
            
            if (output) {
                if (status === 'error') output.classList.add('error');
                if (status === 'success') output.classList.add('success');
            }
        }

        function setVariable(stepNum, key, value) {
            const vars = document.getElementById(`step${stepNum}Vars`);
            if (!vars) return;
            const display = value && typeof value === 'object' ? JSON.stringify(value, null, 2) : String(value);
            vars.innerHTML += `<strong>${key}:</strong> ${display}<br>`;
        }

        function updateProgress(percent) {
            const progressFill = document.getElementById('progressFill');
            if (progressFill) progressFill.style.width = percent + '%';
        }

        // Step 1: Load modules
        window.step1 = async function() {
            try {
                log(1, 'üì¶ Starting module load...');
                updateProgress(12);
                
                // FIRST: Load Supabase library from CDN
                log(1, 'üì¶ Loading Supabase library from CDN...');
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
                        script.onload = () => {
                            log(1, '‚úÖ Supabase library loaded from CDN');
                            resolve();
                        };
                        script.onerror = (e) => {
                            log(1, `‚ö†Ô∏è Failed to load Supabase library: ${e}`);
                            reject(e);
                        };
                        document.head.appendChild(script);
                    });
                } catch (e) {
                    log(1, `‚ö†Ô∏è Supabase library error: ${e.message}`);
                }
                
                log(1, 'üì¶ Loading supabase-config.js...');
                try {
                    // Load supabase-config as a script tag (not module) - MUST LOAD FIRST
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `../../supabase-config.js?t=${Date.now()}`;
                        script.onload = () => {
                            log(1, '‚úÖ supabase-config.js loaded');
                            resolve();
                        };
                        script.onerror = (e) => {
                            log(1, `‚ö†Ô∏è Failed to load supabase-config.js: ${e}`);
                            reject(e);
                        };
                        document.head.appendChild(script);
                    });
                    // Wait for initialization to complete
                    await new Promise(r => setTimeout(r, 2000));
                    log(1, `üìä window.supabaseClient = ${window.supabaseClient ? 'SET' : 'NOT SET'}`);
                    log(1, `üìä window.PlayerDB = ${window.PlayerDB ? 'SET' : 'NOT SET'}`);
                } catch (e) {
                    log(1, `‚ö†Ô∏è supabase-config.js error: ${e.message}`);
                }
                
                log(1, 'üì¶ Loading guest-auth.js...');
                try {
                    // Load guest-auth as a script tag (not module) - MUST LOAD AFTER supabase-config
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = `./guest-auth.js?t=${Date.now()}`;
                        script.onload = () => {
                            log(1, '‚úÖ guest-auth.js loaded');
                            resolve();
                        };
                        script.onerror = (e) => {
                            log(1, `‚ö†Ô∏è Failed to load guest-auth.js: ${e}`);
                            reject(e);
                        };
                        document.head.appendChild(script);
                    });
                    // Wait for guest auth initialization
                    await new Promise(r => setTimeout(r, 2000));
                    log(1, `üìä window.GuestAuth = ${window.GuestAuth ? 'SET' : 'NOT SET'}`);
                } catch (e) {
                    log(1, `‚ö†Ô∏è guest-auth.js error: ${e.message}`);
                }
                
                log(1, 'üì¶ Loading room-manager.js...');
                try {
                    await import(`./room-manager.js?t=${Date.now()}`);
                    log(1, '‚úÖ room-manager.js loaded');
                } catch (e) {
                    log(1, `‚ö†Ô∏è room-manager.js error: ${e.message}`);
                }
                
                // Wait for scripts to initialize
                await new Promise(r => setTimeout(r, 1000));
                
                setStatus(1, 'success');
                return true;
            } catch (error) {
                log(1, `‚ùå Error: ${error.message}`, 'error');
                setStatus(1, 'error');
                testState.errors.push({ step: 1, error });
                return false;
            }
        };

        // Step 2: Initialize Supabase
        window.step2 = async function() {
            try {
                log(2, 'üîå Checking Supabase client...');
                updateProgress(24);
                
                // If supabaseClient not set, try to initialize it directly
                if (!window.supabaseClient && window.supabase && window.getSupabaseClient) {
                    log(2, 'üîß Manually initializing Supabase client...');
                    window.getSupabaseClient();
                }
                
                // Wait for Supabase to be ready
                let retries = 0;
                while (!window.supabaseClient && retries < 20) {
                    log(2, `‚è≥ Waiting for Supabase client... (${retries + 1}/20)`);
                    await new Promise(r => setTimeout(r, 500));
                    retries++;
                }
                
                if (!window.supabaseClient) {
                    throw new Error('Supabase client not initialized');
                }
                
                testState.supabaseClient = window.supabaseClient;
                log(2, '‚úÖ Supabase client ready');
                setVariable(2, 'Supabase URL', window.supabaseClient.supabaseUrl);
                setVariable(2, 'Has Auth', !!window.supabaseClient.auth);
                setVariable(2, 'Has Realtime', !!window.supabaseClient.realtime);
                
                // Log the auth state
                const authSession = await window.supabaseClient.auth.getSession();
                log(2, `üîê Auth session: ${authSession.data.session ? 'AUTHENTICATED' : 'ANON'}`);
                if (authSession.data.session) {
                    log(2, `   User ID: ${authSession.data.session.user.id}`);
                    log(2, `   Email: ${authSession.data.session.user.email}`);
                } else {
                    log(2, `   Using anon key - no authenticated user`);
                }
                
                setStatus(2, 'success');
                return true;
            } catch (error) {
                log(2, `‚ùå Error: ${error.message}`, 'error');
                setStatus(2, 'error');
                testState.errors.push({ step: 2, error });
                return false;
            }
        };

        // Step 3: Initialize GuestAuth
        window.step3 = async function() {
            try {
                log(3, 'üîê Checking GuestAuth...');
                updateProgress(36);
                
                let retries = 0;
                while (!window.GuestAuth && retries < 10) {
                    log(3, `‚è≥ Waiting for GuestAuth... (${retries + 1}/10)`);
                    await new Promise(r => setTimeout(r, 500));
                    retries++;
                }
                
                if (!window.GuestAuth) {
                    throw new Error('GuestAuth not initialized');
                }
                
                log(3, '‚úÖ GuestAuth ready');
                const isGuest = window.GuestAuth.isGuest();
                const guestId = window.localStorage.getItem('guest_id');
                
                setVariable(3, 'Is Guest Mode', isGuest);
                setVariable(3, 'Guest ID', guestId || 'N/A');
                
                if (isGuest) {
                    log(3, `‚úÖ Guest mode active: ${guestId}`);
                } else {
                    log(3, '‚ö†Ô∏è Not in guest mode');
                }
                
                setStatus(3, 'success');
                return true;
            } catch (error) {
                log(3, `‚ùå Error: ${error.message}`, 'error');
                setStatus(3, 'error');
                testState.errors.push({ step: 3, error });
                return false;
            }
        };

        // Step 4: Get Authenticated User ID
        window.step4 = async function() {
            try {
                log(4, 'üë§ Getting authenticated user...');
                updateProgress(48);
                
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                
                if (!session) {
                    throw new Error('Not authenticated - please sign in');
                }
                
                testState.playerId = session.user.id;
                
                log(4, '‚úÖ User authenticated');
                setVariable(4, 'User ID', testState.playerId);
                setVariable(4, 'Email', session.user.email);
                
                setStatus(4, 'success');
                return true;
            } catch (error) {
                log(4, `‚ùå Error: ${error.message}`, 'error');
                setStatus(4, 'error');
                testState.errors.push({ step: 4, error });
                return false;
            }
        };

        // Step 5: Generate Room Code
        window.step5 = async function() {
            try {
                log(5, 'üîë Generating room code...');
                updateProgress(60);
                
                const roomCode = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
                testState.roomCode = roomCode;
                
                log(5, `‚úÖ Room code generated: ${roomCode}`);
                setVariable(5, 'Room Code', roomCode);
                
                setStatus(5, 'success');
                return true;
            } catch (error) {
                log(5, `‚ùå Error: ${error.message}`, 'error');
                setStatus(5, 'error');
                testState.errors.push({ step: 5, error });
                return false;
            }
        };

        // Step 6: Generate UUID
        window.step6 = async function() {
            try {
                log(6, 'üÜî Generating UUID...');
                updateProgress(72);
                
                const roomId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                
                testState.roomId = roomId;
                
                log(6, `‚úÖ UUID generated: ${roomId}`);
                setVariable(6, 'Room ID (UUID)', roomId);
                
                // Validate UUID format
                const uuidRegex = /^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i;
                if (uuidRegex.test(roomId)) {
                    log(6, '‚úÖ UUID format valid');
                } else {
                    log(6, '‚ö†Ô∏è UUID format may be invalid');
                }
                
                setStatus(6, 'success');
                return true;
            } catch (error) {
                log(6, `‚ùå Error: ${error.message}`, 'error');
                setStatus(6, 'error');
                testState.errors.push({ step: 6, error });
                return false;
            }
        };

        // Step 7: Insert Room into Database (via PostgREST with RLS)
        window.step7 = async function() {
            try {
                log(7, 'üíæ Inserting room into database...');
                updateProgress(84);
                
                const insertData = {
                    id: testState.roomId,
                    room_code: testState.roomCode,
                    host_id: testState.playerId,
                    status: 'waiting',
                    game_state: {
                        participants: [{ 
                            id: testState.playerId, 
                            name: 'Host', 
                            joinedAt: new Date().toISOString() 
                        }],
                        createdAt: new Date().toISOString()
                    }
                };
                
                log(7, 'üìã Insert data:', 'info');
                setVariable(7, 'Insert Payload', insertData);
                
                log(7, '‚è≥ Sending insert via PostgREST...');
                log(7, `üì° RLS policy: auth.uid() = host_id`);
                log(7, `üîë Auth user: ${window.supabaseClient?.auth?.user?.id || 'ANON'}`);
                
                const { data, error } = await window.supabaseClient
                    .from('game_rooms')
                    .insert([insertData])
                    .select();
                
                log(7, `üì° Response received. Error: ${error ? 'YES' : 'NO'}, Data: ${data ? 'YES' : 'NO'}`);
                
                if (error) {
                    log(7, `üîç Full error object:`, 'error');
                    log(7, JSON.stringify(error, null, 2), 'error');
                    throw error;
                }
                
                testState.insertedData = data;
                log(7, '‚úÖ Room inserted successfully');
                setVariable(7, 'Response', testState.insertedData);
                
                setStatus(7, 'success');
                return true;
            } catch (error) {
                log(7, `‚ùå Insert failed: ${error.message}`, 'error');
                if (error.code) log(7, `   Error Code: ${error.code}`, 'error');
                if (error.details) log(7, `   Details: ${error.details}`, 'error');
                if (error.hint) log(7, `   Hint: ${error.hint}`, 'error');
                
                setVariable(7, 'Error Code', error.code || 'N/A');
                setVariable(7, 'Error Details', error.details || 'N/A');
                setVariable(7, 'Error Hint', error.hint || 'N/A');
                
                setStatus(7, 'error');
                testState.errors.push({ step: 7, error });
                return false;
            }
        };

        // Step 8: Verify Room Created
        window.step8 = async function() {
            try {
                log(8, 'üîç Verifying room in database...');
                updateProgress(96);
                
                const { data, error } = await window.supabaseClient
                    .from('game_rooms')
                    .select('*')
                    .eq('room_code', testState.roomCode)
                    .single();
                
                if (error) {
                    throw error;
                }
                
                testState.verifiedData = data;
                log(8, '‚úÖ Room verified in database');
                setVariable(8, 'Verified Data', data);
                
                setStatus(8, 'success');
                return true;
            } catch (error) {
                log(8, `‚ö†Ô∏è Verification warning: ${error.message}`, 'error');
                setStatus(8, 'error');
                testState.errors.push({ step: 8, error });
                return false;
            }
        };

        // Summary
        window.showSummary = function() {
            const summaryOutput = document.getElementById('summaryOutput');
            const errors = testState.errors;
            
            updateProgress(100);
            
            let summaryText = 'TEST SUMMARY\n';
            summaryText += '============\n';
            summaryText += 'Total Errors: ' + errors.length + '\n';
            summaryText += 'Room Code: ' + (testState.roomCode || 'N/A') + '\n';
            summaryText += 'Room ID: ' + (testState.roomId || 'N/A') + '\n';
            summaryText += 'Player ID: ' + (testState.playerId || 'N/A') + '\n\n';
            
            if (errors.length === 0) {
                summaryText += '‚úÖ ALL TESTS PASSED!\n';
            } else {
                summaryText += '‚ùå TESTS FAILED\n\n';
                summaryText += 'ERRORS:\n';
                errors.forEach((e, i) => {
                    summaryText += '  Step ' + e.step + ': ' + e.error.message + '\n';
                });
            }
            
            summaryOutput.textContent = summaryText;
            setStatus('summary', errors.length === 0 ? 'success' : 'error');
        };

        // Run full test
        window.runFullTest = async function() {
            clearLogs();
            log('summary', 'Running full test...\n');
            
            const steps = [1, 2, 3, 4, 5, 6, 7, 8];
            for (const step of steps) {
                const success = await window[`step${step}`]();
                if (!success && [1, 2, 3, 4].includes(step)) {
                    log('summary', `Test stopped at step ${step}`);
                    showSummary();
                    return;
                }
                await new Promise(r => setTimeout(r, 300));
            }
            
            showSummary();
        };

        // Run step by step (with user prompts)
        window.runStepByStep = async function() {
            clearLogs();
            log('summary', 'Ready for step-by-step testing.\n');
            log('summary', 'Run each step manually or click Run Full Test\n');
        };

        // Clear logs
        window.clearLogs = function() {
            for (let i = 1; i <= 8; i++) {
                const output = document.getElementById(`step${i}Output`);
                const vars = document.getElementById(`step${i}Vars`);
                const icon = document.getElementById(`step${i}Icon`);
                if (output) output.textContent = '';
                if (output) output.classList.remove('error', 'success');
                if (vars) vars.innerHTML = '';
                if (icon) {
                    icon.textContent = '‚è≥';
                    icon.className = 'status-icon pending';
                }
            }
            const summaryOutput = document.getElementById('summaryOutput');
            const summaryIcon = document.getElementById('summaryIcon');
            if (summaryOutput) summaryOutput.textContent = '';
            if (summaryIcon) {
                summaryIcon.textContent = '‚è≥';
                summaryIcon.className = 'status-icon pending';
            }
            const progressFill = document.getElementById('progressFill');
            if (progressFill) progressFill.style.width = '0%';
            testState.errors = [];
            console.clear();
        };

        // Check auth on page load
        async function checkAuth() {
            try {
                // Wait for Supabase client to be ready (with longer timeout)
                let retries = 0;
                while (!window.supabaseClient && retries < 30) {
                    await new Promise(r => setTimeout(r, 100));
                    retries++;
                }
                
                if (!window.supabaseClient) {
                    console.warn('Supabase client not initialized after 3 seconds');
                    showAuthWall();
                    return;
                }
                
                console.log('‚úÖ Supabase client ready, checking auth session...');
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                
                if (session) {
                    console.log('‚úÖ User already authenticated:', session.user.email);
                    hideAuthWall();
                } else {
                    console.log('‚ö†Ô∏è No active session, showing auth wall');
                    showAuthWall();
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showAuthWall();
            }
        }
        
        function showAuthWall() {
            const authWall = document.getElementById('authWall');
            const testContainer = document.getElementById('testContainer');
            if (authWall) authWall.style.display = 'flex';
            if (testContainer) testContainer.style.display = 'none';
        }
        
        function hideAuthWall() {
            const authWall = document.getElementById('authWall');
            const testContainer = document.getElementById('testContainer');
            if (authWall) authWall.style.display = 'none';
            if (testContainer) testContainer.style.display = 'block';
        }
        
        // Run auth check after a brief delay to ensure Supabase loads
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(checkAuth, 500);
        });
    </script>
</body>
</html>
