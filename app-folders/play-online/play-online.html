<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="DartStream Play Online - Peer-to-peer video calling room">
    <meta name="theme-color" content="#FF6B35">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>DartStream Play Online</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="dartstream-logo.png">
    <link rel="stylesheet" href="styles.css">
    <script src="guest-auth.js"></script>
</head>
<body>
    <!-- Auth Wall (shown if not logged in) -->
    <div id="authWall" class="auth-wall" style="display: none;">
        <div class="auth-wall-content">
            <div class="auth-wall-card">
                <h2>üîê Sign In Required</h2>
                <p>You need to be signed in to use DartStream Play Online.</p>
                <p>This allows us to track your stats and connect you with other players.</p>
                
                <div class="auth-buttons-container">
                    <a href="../player-account/player-account.html?action=login&return=play-online" class="auth-btn sign-in">
                        ‚úì Sign In
                    </a>
                    <a href="../player-account/player-account.html?action=register&return=play-online" class="auth-btn create">
                        + Create Account
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar play-online">
        <div class="navbar-brand">
            <img src="dartstream-logo.png" alt="DartStream" class="logo">
            <h1>DartStream Play Online</h1>
            <span class="version-badge">v2.9</span>
        </div>
        <div class="navbar-status">
            <span id="statusIndicator" class="status-dot offline"></span>
            <span id="statusText">Ready</span>
        </div>
    </nav>

    <!-- Main App Container -->
    <div class="play-online-container">
        
        <!-- SCREEN 1: Host or Join -->
        <div id="hostOrJoinScreen" class="screen active">
            <div class="screen-content">
                <div class="setup-card welcome-card">
                    <div class="welcome-header">
                        <img src="../../Video Stream Logo.png" alt="Video Stream" class="welcome-logo">
                        <h1>DartStream Play Online</h1>
                        <p class="subtitle">Challenge your opponent to a live darts match via video call</p>
                    </div>
                    
                    <div class="room-options-grid">
                        <!-- Host Game Option -->
                        <div class="room-option-card host-card">
                            <div class="option-icon">üÜï</div>
                            <h3>Host Game</h3>
                            <p>Start a new video game session. You'll get a unique 4-digit code to share with your opponent.</p>
                            <button id="hostGameBtn" class="btn btn-primary btn-large btn-prominent">
                                Host Game
                            </button>
                            <div class="option-features">
                                <span>‚úì Get unique code</span>
                                <span>‚úì Invite opponent</span>
                                <span>‚úì Start video call</span>
                            </div>
                        </div>
                        
                        <!-- Divider -->
                        <div class="divider-card">
                            <span class="divider-text">or</span>
                        </div>
                        
                        <!-- Join Game Option -->
                        <div class="room-option-card join-card">
                            <div class="option-icon">üîó</div>
                            <h3>Join Game</h3>
                            <p id="joinPromptText">Have a 4-digit code from your opponent? Click below to join their game.</p>
                            
                            <!-- Code Input (Hidden Initially) -->
                            <div id="joinCodeContainer" style="display: none;">
                                <input 
                                    type="text" 
                                    id="joinRoomCodeInput" 
                                    placeholder="Enter 4-digit code" 
                                    maxlength="4"
                                    pattern="[0-9]{4}"
                                    class="room-code-input join-code-input"
                                    autocomplete="off"
                                >
                                <small id="joinCodeError" class="error-text"></small>
                                <div class="join-button-group">
                                    <button id="joinGameBtn" class="btn btn-primary btn-large" style="flex: 1;">
                                        Join Game
                                    </button>
                                    <button id="cancelJoinBtn" class="btn btn-secondary" style="flex: 1;">
                                        Cancel
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Initial Join Button -->
                            <button id="joinPromptBtn" class="btn btn-secondary btn-large btn-prominent">
                                Join Game
                            </button>
                            
                            <div class="option-features">
                                <span>‚úì Enter code</span>
                                <span>‚úì Join instantly</span>
                                <span>‚úì Start playing</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 2: Room Lobby (Waiting for Peers) -->
        <div id="lobbyScreen" class="screen">
            <div class="screen-content">
                <div class="lobby-card">
                    <div class="lobby-header">
                        <h2>Room: <span id="roomCodeDisplay" class="room-code"></span></h2>
                        <div class="header-buttons">
                            <button id="editSettingsBtn" class="btn btn-sm btn-secondary" style="display: none;" title="Adjust camera settings">
                                ‚öôÔ∏è Configure
                            </button>
                            <button id="copyRoomCodeBtn" class="btn btn-sm btn-secondary">
                                üìã Copy Code
                            </button>
                        </div>
                    </div>
                    
                    <div class="lobby-content">
                        <div class="local-video-section">
                            <h3>You</h3>
                            <div id="localVideoContainer" class="video-container"></div>
                            <div class="player-label" id="localPlayerLabel"></div>
                            
                            <!-- Device Selection -->
                            <div class="device-selection">
                                <div class="device-item">
                                    <label for="cameraSelect">üìπ Camera:</label>
                                    <div class="device-row">
                                        <select id="cameraSelect" class="device-select">
                                            <option value="">Loading cameras...</option>
                                        </select>
                                        <span id="cameraStatus" class="device-status disconnected">üî¥ Disconnected</span>
                                    </div>
                                </div>
                                
                                <div class="device-item">
                                    <label for="microphoneSelect">üéôÔ∏è Microphone:</label>
                                    <div class="device-row">
                                        <select id="microphoneSelect" class="device-select">
                                            <option value="">Loading microphones...</option>
                                        </select>
                                        <span id="microphoneStatus" class="device-status disconnected">üî¥ Disconnected</span>
                                    </div>
                                </div>
                                
                                <button id="confirmDevicesBtn" class="btn btn-primary btn-block" style="margin-top: 1rem;">
                                    ‚úì Confirm Settings
                                </button>
                            </div>
                            
                            <!-- Camera Settings Modal -->
                            <div id="cameraSettingsModal" class="modal" style="display: none;">
                                <div class="modal-content camera-settings-panel">
                                    <div class="modal-header">
                                        <h3>‚öôÔ∏è Camera Settings</h3>
                                        <button class="modal-close" id="closeSettingsBtn">‚úï</button>
                                    </div>
                                    
                                    <div class="settings-controls">
                                        <!-- Device Selection in Settings -->
                                        <div class="setting-item">
                                            <label for="settingsCameraSelect">üìπ Camera</label>
                                            <select id="settingsCameraSelect" class="device-select">
                                                <option value="">Loading cameras...</option>
                                            </select>
                                        </div>
                                        
                                        <div class="setting-item">
                                            <label for="settingsMicrophoneSelect">üéôÔ∏è Microphone</label>
                                            <select id="settingsMicrophoneSelect" class="device-select">
                                                <option value="">Loading microphones...</option>
                                            </select>
                                        </div>
                                        
                                        <!-- Image Adjustments -->
                                        <div style="border-top: 1px solid #eee; padding-top: 1rem; margin-top: 1rem;">
                                            <div class="setting-item">
                                                <label for="brightnessSlider">üîÜ Brightness</label>
                                                <input 
                                                    type="range" 
                                                    id="brightnessSlider" 
                                                    min="50" 
                                                    max="150" 
                                                    value="100" 
                                                    class="settings-slider"
                                                >
                                                <span id="brightnessValue">100%</span>
                                            </div>
                                            
                                            <div class="setting-item">
                                                <label for="contrastSlider">‚ö´ Contrast</label>
                                                <input 
                                                    type="range" 
                                                    id="contrastSlider" 
                                                    min="50" 
                                                    max="150" 
                                                    value="100" 
                                                    class="settings-slider"
                                                >
                                                <span id="contrastValue">100%</span>
                                            </div>
                                            
                                            <div class="setting-item">
                                                <label for="saturationSlider">üé® Saturation</label>
                                                <input 
                                                    type="range" 
                                                    id="saturationSlider" 
                                                    min="0" 
                                                    max="200" 
                                                value="100" 
                                                class="settings-slider"
                                            >
                                            <span id="saturationValue">100%</span>
                                        </div>
                                        
                                        <div class="setting-item">
                                            <label for="hueSlider">üåà Hue</label>
                                            <input 
                                                type="range" 
                                                id="hueSlider" 
                                                min="0" 
                                                max="360" 
                                                value="0" 
                                                class="settings-slider"
                                            >
                                            <span id="hueValue">0¬∞</span>
                                        </div>
                                        </div>
                                    </div>
                                    
                                    <div class="settings-actions">
                                        <button id="resetSettingsBtn" class="btn btn-secondary">
                                            ‚Ü∫ Reset
                                        </button>
                                        <button id="applySettingsBtn" class="btn btn-primary">
                                            ‚úì Apply
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="peers-section">
                            <h3>Participants (<span id="participantCount">1</span>)</h3>
                            <div id="participantsList" class="participants-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <div class="lobby-status">
                        <p id="lobbyStatusMessage">Waiting for peers to join...</p>
                    </div>
                    
                    <div class="lobby-actions">
                        <button id="startVideoBtn" class="btn btn-primary btn-large" disabled>
                            ‚ñ∂Ô∏è Start Video Call
                        </button>
                        <button id="leaveLobbyBtn" class="btn btn-secondary">
                            Leave Room
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- SCREEN 4: Active Video Call -->
        <div id="videoCallScreen" class="screen">
            <div class="video-call-grid">
                <!-- Local Video -->
                <div class="video-grid-item local">
                    <video id="localVideo" autoplay playsinline muted></video>
                    <div class="video-label local-label" id="localVideoLabel"></div>
                </div>
                
                <!-- Remote Videos Container -->
                <div id="remoteVideosContainer" class="remote-videos">
                    <!-- Remote peer videos populated by JS -->
                </div>
            </div>
            
            <!-- Video Call Controls -->
            <div class="video-controls">
                <button id="micToggleBtn" class="btn btn-control btn-mic" title="Toggle Microphone">
                    üéôÔ∏è
                </button>
                <button id="cameraToggleBtn" class="btn btn-control btn-camera" title="Toggle Camera">
                    üìπ
                </button>
                <button id="screenShareBtn" class="btn btn-control btn-share" title="Share Screen" disabled>
                    üñ•Ô∏è
                </button>
                <button id="hangupBtn" class="btn btn-control btn-hang-up" title="End Call">
                    üìû
                </button>
            </div>
            
            <!-- Call Info Bar -->
            <div class="call-info">
                <span id="callDuration">00:00</span>
                <span id="connectionStatus" class="connection-status">Connected</span>
            </div>
        </div>

        <!-- SCREEN 5: Call Ended -->
        <div id="endedScreen" class="screen">
            <div class="screen-content">
                <div class="ended-card">
                    <h2>Call Ended</h2>
                    <div class="ended-stats">
                        <div class="stat">
                            <span class="stat-label">Duration:</span>
                            <span id="finalDuration" class="stat-value">00:00</span>
                        </div>
                        <div class="stat">
                            <span class="stat-label">Participants:</span>
                            <span id="finalParticipantCount" class="stat-value">2</span>
                        </div>
                    </div>
                    
                    <div class="ended-actions">
                        <button id="newCallBtn" class="btn btn-primary">
                            Start New Call
                        </button>
                        <button id="exitAppBtn" class="btn btn-secondary">
                            Exit to Home
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Indicator -->
    <div id="loadingIndicator" class="loading-overlay" style="display: none;">
        <div class="spinner"></div>
        <p id="loadingText">Loading...</p>
    </div>

    <!-- Error Modal -->
    <div id="errorModal" class="modal" style="display: none;">
        <div class="modal-content">
            <h3>Error</h3>
            <p id="errorMessage"></p>
            <button id="errorCloseBtn" class="btn btn-primary">OK</button>
        </div>
    </div>

    <!-- Supabase & App Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../supabase-config.js"></script>
    <script>
        // Check authentication before loading the app
        async function checkAuth() {
            try {
                // Wait for Supabase client to be ready
                let retries = 0;
                while (!window.supabaseClient && retries < 10) {
                    await new Promise(r => setTimeout(r, 100));
                    retries++;
                }
                
                if (!window.supabaseClient) {
                    console.error('Supabase client not initialized');
                    showAuthWall();
                    return;
                }
                
                const { data: { session } } = await window.supabaseClient.auth.getSession();
                
                if (!session) {
                    // Not logged in - show auth wall
                    showAuthWall();
                } else {
                    // Logged in - hide auth wall and continue loading app
                    hideAuthWall();
                }
            } catch (error) {
                console.error('Error checking auth:', error);
                showAuthWall();
            }
        }
        
        function showAuthWall() {
            const authWall = document.getElementById('authWall');
            if (authWall) {
                authWall.style.display = 'flex';
            }
            // Hide the main app
            const container = document.querySelector('.play-online-container');
            if (container) {
                container.style.display = 'none';
            }
        }
        
        function hideAuthWall() {
            const authWall = document.getElementById('authWall');
            if (authWall) {
                authWall.style.display = 'none';
            }
            // Show the main app
            const container = document.querySelector('.play-online-container');
            if (container) {
                container.style.display = 'block';
            }
        }
        
        // Check auth when page loads
        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
    <script src="browser-detect.js"></script>
    <script src="video-room.js?v=3"></script>
    <script src="room-manager.js?v=3"></script>
    <script src="play-online-app.js?v=3"></script>
    <script src="play-online.js?v=3"></script>
</body>
</html>
