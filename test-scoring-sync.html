<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Scoring Sync - DartStream</title>
    <style>
        body {
            background: #0f172a;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .setup-area {
            background: rgba(30, 41, 59, 0.9);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }
        .status-box {
            background: #0f172a;
            border: 2px solid #facc15;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-box.connected {
            border-color: #10b981;
        }
        .status-box.error {
            border-color: #ef4444;
        }
        .btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
        }
        .btn.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .btn.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        .log-area {
            background: #000;
            border: 2px solid #334155;
            border-radius: 8px;
            padding: 15px;
            height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
        }
        .log-entry {
            margin: 5px 0;
            padding: 5px;
        }
        .log-entry.info { color: #3b82f6; }
        .log-entry.success { color: #10b981; }
        .log-entry.error { color: #ef4444; }
        .log-entry.broadcast { color: #facc15; }
        .split-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            border-radius: 8px;
        }
        .scoring-iframe {
            width: 100%;
            height: 800px;
            border: 2px solid #334155;
            border-radius: 8px;
        }
        .input-field {
            padding: 10px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: white;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 style="color: #facc15; text-align: center;">üéØ Scoring Sync Test</h1>
        
        <div class="setup-area">
            <h2>Connection Setup</h2>
            
            <div class="status-box" id="supabase-status">
                <strong>Supabase:</strong> <span id="supabase-text">Initializing...</span>
            </div>
            
            <div class="status-box" id="channel-status">
                <strong>Realtime Channel:</strong> <span id="channel-text">Not connected</span>
            </div>
            
            <div style="margin: 20px 0;">
                <label style="color: #94a3b8;">Room Code (4 digits):</label>
                <input type="text" id="room-code-input" maxlength="4" placeholder="e.g., 1234" class="input-field" style="width: 100px;">
                <button class="btn" onclick="createRoom()">Create Room</button>
                <button class="btn success" onclick="joinRoom()">Join Room</button>
            </div>
            
            <div style="margin: 20px 0;">
                <button class="btn" onclick="testBroadcast()">Send Test Broadcast</button>
                <button class="btn danger" onclick="clearLogs()">Clear Logs</button>
            </div>
        </div>
        
        <div class="setup-area">
            <h2>Debug Console</h2>
            <div class="log-area" id="debug-log"></div>
        </div>
        
        <div class="split-view" id="game-view" style="display: none;">
            <div>
                <h3 style="color: #3b82f6; text-align: center;">Player 1 (Host) View</h3>
                <iframe id="player1-iframe" class="scoring-iframe" src="about:blank"></iframe>
            </div>
            <div>
                <h3 style="color: #ef4444; text-align: center;">Player 2 (Guest) View</h3>
                <iframe id="player2-iframe" class="scoring-iframe" src="about:blank"></iframe>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Inline Supabase Configuration
        const SUPABASE_URL = 'https://kswwbqumgsdissnwuiab.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imtzd3dicXVtZ3NkaXNzbnd1aWFiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ0ODMwNTIsImV4cCI6MjA4MDA1OTA1Mn0.b-z8JqL1dBYJcrrzSt7u6VAaFAtTOl1vqqtFFgHkJ50';
        
        // Initialize Supabase client immediately
        window.supabaseClient = null;
        
        function initializeSupabase() {
            if (typeof window.supabase !== 'undefined' && window.supabase.createClient) {
                try {
                    window.supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    console.log('‚úÖ Supabase client initialized');
                    return true;
                } catch (error) {
                    console.error('‚ùå Error initializing Supabase:', error);
                    return false;
                }
            } else {
                console.log('‚è≥ Waiting for Supabase library...');
                setTimeout(initializeSupabase, 100);
                return false;
            }
        }
        
        // Start initialization
        setTimeout(initializeSupabase, 100);
        
        let supabaseChannel = null;
        let currentRoomCode = null;
        let isHost = false;
        
        // Logging functions
        function log(message, type = 'info') {
            const logArea = document.getElementById('debug-log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            logArea.appendChild(entry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        function clearLogs() {
            document.getElementById('debug-log').innerHTML = '';
            log('Logs cleared', 'info');
        }
        
        // Wait for Supabase
        async function waitForSupabase() {
            let attempts = 0;
            while (!window.supabaseClient && attempts < 50) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.supabaseClient) {
                document.getElementById('supabase-status').classList.add('connected');
                document.getElementById('supabase-text').textContent = 'Connected ‚úì';
                log('Supabase client initialized', 'success');
                return true;
            } else {
                document.getElementById('supabase-status').classList.add('error');
                document.getElementById('supabase-text').textContent = 'Failed to connect ‚úó';
                log('Supabase initialization failed', 'error');
                return false;
            }
        }
        
        // Create room
        async function createRoom() {
            const roomCodeInput = document.getElementById('room-code-input');
            const roomCode = roomCodeInput.value.trim();
            
            if (roomCode.length !== 4) {
                log('Room code must be 4 digits', 'error');
                return;
            }
            
            if (!window.supabaseClient) {
                log('Waiting for Supabase...', 'info');
                await waitForSupabase();
            }
            
            log(`Creating room with code: ${roomCode}`, 'info');
            currentRoomCode = roomCode;
            isHost = true;
            
            // Set up Realtime channel
            setupRealtimeChannel(roomCode);
            
            // Show game view
            document.getElementById('game-view').style.display = 'grid';
            
            // Load scoring app in host iframe
            const iframe = document.getElementById('player1-iframe');
            iframe.src = 'scoring-app.html?v=3';
            
            log('Host view ready - waiting for guest to join', 'success');
        }
        
        // Join room
        async function joinRoom() {
            const roomCodeInput = document.getElementById('room-code-input');
            const roomCode = roomCodeInput.value.trim();
            
            if (roomCode.length !== 4) {
                log('Room code must be 4 digits', 'error');
                return;
            }
            
            if (!window.supabaseClient) {
                log('Waiting for Supabase...', 'info');
                await waitForSupabase();
            }
            
            log(`Joining room with code: ${roomCode}`, 'info');
            currentRoomCode = roomCode;
            isHost = false;
            
            // Set up Realtime channel
            setupRealtimeChannel(roomCode);
            
            // Show game view
            document.getElementById('game-view').style.display = 'grid';
            
            // Load scoring app in guest iframe
            const iframe = document.getElementById('player2-iframe');
            iframe.src = 'scoring-app.html?v=3';
            
            log('Guest view ready', 'success');
        }
        
        // Setup Realtime channel
        function setupRealtimeChannel(roomCode) {
            log(`Setting up Realtime channel for room: ${roomCode}`, 'info');
            
            // Remove old channel if exists
            if (supabaseChannel) {
                log('Removing old channel...', 'info');
                supabaseChannel.unsubscribe();
            }
            
            // Create new channel with ALL listeners BEFORE subscribe
            supabaseChannel = window.supabaseClient
                .channel(`test-room:${roomCode}`)
                .on('broadcast', { event: 'score-update' }, (payload) => {
                    log(`üì° Received score-update broadcast: ${JSON.stringify(payload.payload)}`, 'broadcast');
                    
                    // Forward to the appropriate iframe
                    const targetIframe = isHost ? 
                        document.getElementById('player2-iframe') : 
                        document.getElementById('player1-iframe');
                    
                    if (targetIframe && targetIframe.contentWindow) {
                        targetIframe.contentWindow.postMessage({
                            type: 'update-game-state',
                            gameState: payload.payload
                        }, '*');
                        log('Forwarded score update to iframe', 'success');
                    }
                })
                .on('broadcast', { event: 'game-config' }, (payload) => {
                    log(`üì° Received game-config broadcast: ${JSON.stringify(payload.payload)}`, 'broadcast');
                })
                .on('broadcast', { event: 'test-message' }, (payload) => {
                    log(`üì° Received test-message: ${JSON.stringify(payload.payload)}`, 'broadcast');
                })
                .subscribe((status) => {
                    log(`Channel subscription status: ${status}`, status === 'SUBSCRIBED' ? 'success' : 'info');
                    
                    if (status === 'SUBSCRIBED') {
                        document.getElementById('channel-status').classList.add('connected');
                        document.getElementById('channel-text').textContent = `Connected to room ${roomCode} ‚úì`;
                    }
                });
            
            log('Realtime channel configured with broadcast listeners', 'success');
        }
        
        // Test broadcast
        function testBroadcast() {
            if (!supabaseChannel) {
                log('No active channel - create or join a room first', 'error');
                return;
            }
            
            const testData = {
                message: 'Test broadcast',
                timestamp: new Date().toISOString(),
                from: isHost ? 'host' : 'guest'
            };
            
            log(`Sending test broadcast: ${JSON.stringify(testData)}`, 'info');
            
            supabaseChannel.send({
                type: 'broadcast',
                event: 'test-message',
                payload: testData
            });
            
            log('Test broadcast sent', 'success');
        }
        
        // Listen for messages from iframes
        window.addEventListener('message', (event) => {
            if (event.data.type === 'score-update') {
                log(`üì§ Iframe sent score-update: ${JSON.stringify(event.data)}`, 'info');
                
                // Broadcast to other player
                if (supabaseChannel) {
                    supabaseChannel.send({
                        type: 'broadcast',
                        event: 'score-update',
                        payload: event.data
                    });
                    log('Score update broadcasted to opponent', 'success');
                } else {
                    log('No channel available to broadcast', 'error');
                }
            }
        });
        
        // Initialize
        window.addEventListener('load', async () => {
            log('Test page loaded', 'info');
            await waitForSupabase();
        });
    </script>
</body>
</html>
